<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self'; form-action 'self'; frame-src 'self'; img-src 'self' data: https://*.google-analytics.com https://*.googletagmanager.com; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://*.googletagmanager.com; prefetch-src 'self'; connect-src 'self' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CryptoHack: Symmetric Cryptography | woadey</title><meta name=keywords content="cryptohack,crypto,modular,arithmetic"><meta name=description content="Writeups for CryptoHack's Symmetric Cryptography Course"><meta name=author content><link rel=canonical href=https://woadey.lol/posts/cryptohack/symmetric_cryptography/><link crossorigin=anonymous href=/assets/css/stylesheet.fa85d23654f771919662f96336085a88f71dcede34c2311cf3b1550bc761502d.css integrity="sha256-+oXSNlT3cZGWYvljNghaiPcdzt40wjEc87FVC8dhUC0=" rel="preload stylesheet" as=style><link rel=icon href=https://woadey.lol/favicon/pink_trans_bg/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://woadey.lol/favicon/pink_trans_bg/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://woadey.lol/favicon/pink_trans_bg/favicon-32x32.png><link rel=apple-touch-icon href=https://woadey.lol/favicon/white_pink_bg/apple-touch-icon.png><link rel=mask-icon href=https://woadey.lol/favicon/pink_trans_bg/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-EF924K1NXR"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EF924K1NXR",{anonymize_ip:!1})}</script><meta property="og:title" content="CryptoHack: Symmetric Cryptography"><meta property="og:description" content="Writeups for CryptoHack's Symmetric Cryptography Course"><meta property="og:type" content="article"><meta property="og:url" content="https://woadey.lol/posts/cryptohack/symmetric_cryptography/"><meta property="og:image" content="https://cryptohack.org/static/img/courses/symmetric.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-08T22:07:33-07:00"><meta property="article:modified_time" content="2022-11-08T22:07:33-07:00"><meta property="og:site_name" content="woadey's blog"><meta name=twitter:title content="CryptoHack: Symmetric Cryptography"><meta name=twitter:description content="Writeups for CryptoHack's Symmetric Cryptography Course"><meta name=twitter:site content="@woadey_"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://cryptohack.org/static/img/courses/symmetric.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"posts","item":"https://woadey.lol/posts/"},{"@type":"ListItem","position":2,"name":"CryptoHack: Symmetric Cryptography","item":"https://woadey.lol/posts/cryptohack/symmetric_cryptography/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CryptoHack: Symmetric Cryptography","name":"CryptoHack: Symmetric Cryptography","description":"Writeups for CryptoHack's Symmetric Cryptography Course","keywords":["cryptohack","crypto","modular","arithmetic"],"articleBody":"Keyed Permutations AES, like all good block ciphers, performs a “keyed permutation”. This means that it maps every possible input block to a unique output block, with a key determining which permutation to perform.\nUsing the same key, the permutation can be performed in reverse, mapping the output block back to the original input block. It is important that there is a one-to-one correspondence between input and output blocks, otherwise we wouldn’t be able to rely on the ciphertext to decrypt back to the same plaintext we started with. What is the mathematical term for a one-to-one correspondence?\nSolution flag: crypto{bijection}\nResisting Bruteforce If a block cipher is secure, there should be no way for an attacker to distinguish the output of AES from a random permutation of bits. Furthermore, there should be no better way to undo the permutation than simply bruteforcing every possible key. That’s why academics consider a cipher theoretically “broken” if they can find an attack that takes fewer steps to perform than bruteforcing the key, even if that attack is practically infeasible.\nIt turns out that there is an attack on AES that’s better than bruteforce, but only slightly – it lowers the security level of AES-128 down to 126.1 bits, and hasn’t been improved on for over 8 years. Given the large “security margin” provided by 128 bits, and the lack of improvements despite extensive study, it’s not considered a credible risk to the security of AES. But yes, in a very narrow sense, it “breaks” AES.\nFinally, while quantum computers have the potential to completely break popular public-key cryptosystems like RSA via Shor’s algorithm, they are thought to only cut in half the security level of symmetric cryptosystems via Grover’s algorithm. This is one reason why people recommend using AES-256, despite it being less performant, as it would still provide a very adequate 128 bits of security in a quantum future.\nWhat is the name for the best single-key attack against AES?\nSolution flag: crypto{biclique}\nStructure of AES To achieve a keyed permutation that is infeasible to invert without the key, AES applies a large number of ad-hoc mixing operations on the input. This is in stark contrast to public-key cryptosystems like RSA, which are based on elegant individual mathematical problems. AES is much less elegant, but it’s very fast.\nAt a high level, AES-128 begins with a “key schedule” and then runs 10 rounds over a state. The starting state is just the plaintext block that we want to encrypt, represented as a 4x4 matrix of bytes. Over the course of the 10 rounds, the state is repeatedly modified by a number of invertible transformations.\nHere’s an overview of the phases of AES encryption:\nKeyExpansion or Key Schedule From the 128 bit key, 11 separate 128 bit “round keys” are derived: one to be used in each AddRoundKey step.\nInitial key addition AddRoundKey - the bytes of the first round key are XOR’d with the bytes of the state.\nRound - this phase is looped 10 times, for 9 main rounds plus one “final round” a) SubBytes - each byte of the state is substituted for a different byte according to a lookup table (“S-box”).\nb) ShiftRows - the last three rows of the state matrix are transposed—shifted over a column or two or three.\nc) MixColumns - matrix multiplication is performed on the columns of the state, combining the four bytes in each column. This is skipped in the final round.\nd) AddRoundKey - the bytes of the current round key are XOR’d with the bytes of the state.\nIncluded is a bytes2matrix function for converting our initial plaintext block into a state matrix. Write a matrix2bytes function to turn that matrix back into bytes, and submit the resulting plaintext as the flag.\nChallenge files:\nmatrix.py Resources:\nYouTube: AES Rijndael Cipher explained as a Flash animation file: matrix.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def bytes2matrix(text): \"\"\" Converts a 16-byte array into a 4x4 matrix. \"\"\" return [list(text[i:i+4]) for i in range(0, len(text), 4)] def matrix2bytes(matrix): \"\"\" Converts a 4x4 matrix into a 16-byte array. \"\"\" ???? matrix = [ [99, 114, 121, 112], [116, 111, 123, 105], [110, 109, 97, 116], [114, 105, 120, 125], ] print(matrix2bytes(matrix)) Solution 1 2 def matrix2bytes(matrix): return \"\".join([chr(n) for lst in matrix for n in lst]) \u003e print(matrix2bytes(matrix)) crypto{inmatrix} Alternative solution(s):\n1 2 3 4 5 # source: CryptoHack user @Robin_Jadoul def matrix2bytes(matrix): \"\"\" Converts a 4x4 matrix into a 16-byte array. \"\"\" return bytes(sum(matrix, [])) flag: crypto{inmatrix}\nRound Keys We’re going to skip over the finer details of the KeyExpansion phase for now. The main point is that it takes in our 16 byte key and produces 11 4x4 matrices called “round keys” derived from our initial key. These round keys allow AES to get extra mileage out of the single key that we provided.\nThe initial key addition phase, which is next, has a single AddRoundKey step. The AddRoundKey step is straightforward: it XORs the current state with the current round key.\nAddRoundKey also occurs as the final step of each round. AddRoundKey is what makes AES a “keyed permutation” rather than just a permutation. It’s the only part of AES where the key is mixed into the state, but is crucial for determining the permutation that occurs.\nAs you’ve seen in previous challenges, XOR is an easily invertible operation if you know the key, but tough to undo if you don’t. Now imagine trying to recover plaintext which has been XOR’d with 11 different keys, and heavily jumbled between each XOR operation with a series of substitution and transposition ciphers. That’s kinda what AES does! And we’ll see just how effective the jumbling is in the next few challenges.\nComplete the add_round_key function, then use the matrix2bytes function to get your next flag.\nChallenge files:\nadd_round_key.py file: add_round_key.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 state = [ [206, 243, 61, 34], [171, 11, 93, 31], [16, 200, 91, 108], [150, 3, 194, 51], ] round_key = [ [173, 129, 68, 82], [223, 100, 38, 109], [32, 189, 53, 8], [253, 48, 187, 78], ] def add_round_key(s, k): ??? print(add_round_key(state, round_key)) Solution 1 2 def add_round_key(s, k): return [[x^y for x,y in zip(sum(s,[]), sum(k,[]))][i:i+4] for i in range(0,16,4)] or\n1 2 def add_round_key(s, k): return [[s_val^k_val for s_val, k_val in zip(s_lst,k_lst)] for s_lst, k_lst in zip(s, k)] \u003e add_round_key(state, round_key) [[99, 114, 121, 112], [116, 111, 123, 114], [48, 117, 110, 100], [107, 51, 121, 125]] \u003e print(matrix2bytes(add_round_key(state, round_key))) crypto{r0undk3y} flag: crypto{r0undk3y}\nConfusion through Substitution The first step of each AES round is SubBytes. This involves taking each byte of the state matrix and substituting it for a different byte in a preset 16x16 lookup table. The lookup table is called a “Substitution box” or “S-box” for short, and can be perplexing at first sight. Let’s break it down.\nIn 1945 American mathematician Claude Shannon published a groundbreaking paper on Information Theory. It identified “confusion” as an essential property of a secure cipher. “Confusion” means that the relationship between the ciphertext and the key should be as complex as possible. Given just a ciphertext, there should be no way to learn anything about the key.\nIf a cipher has poor confusion, it is possible to express a relationship between ciphertext, key, and plaintext as a linear function. For instance, in a Caesar cipher, ciphertext = plaintext + key. That’s an obvious relation, which is easy to reverse. More complicated linear transformations can be solved using techniques like Gaussian elimination. Even low-degree polynomials, e.g. an equation like x^4 + 51x^3 + x, can be solved efficiently using algebraic methods. However, the higher the degree of a polynomial, generally the harder it becomes to solve – it can only be approximated by a larger and larger amount of linear functions.\nThe main purpose of the S-box is to transform the input in a way that is resistant to being approximated by linear functions. S-boxes are aiming for high non-linearity, and while AES’s one is not perfect, it’s pretty close. The fast lookup in an S-box is a shortcut for performing a very nonlinear function on the input bytes. This function involves taking the modular inverse in the Galois field 2**8 and then applying an affine transformation which has been tweaked for maximum confusion. The simplest way to express the function is through the following high-degree polynomial:\ndiagram showing S-Box equation\nTo make the S-box, the function has been calculated on all input values from 0x00 to 0xff and the outputs put in the lookup table.\nImplement sub_bytes, send the state matrix through the inverse S-box and then convert it to bytes to get the flag.\nChallenge files:\nsbox.py file: sbox.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 s_box = ( 0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76, 0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0, 0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15, 0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75, 0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84, 0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF, 0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8, 0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2, 0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73, 0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB, 0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79, 0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08, 0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A, 0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E, 0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF, 0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16, ) inv_s_box = ( 0x52, 0x09, 0x6A, 0xD5, 0x30, 0x36, 0xA5, 0x38, 0xBF, 0x40, 0xA3, 0x9E, 0x81, 0xF3, 0xD7, 0xFB, 0x7C, 0xE3, 0x39, 0x82, 0x9B, 0x2F, 0xFF, 0x87, 0x34, 0x8E, 0x43, 0x44, 0xC4, 0xDE, 0xE9, 0xCB, 0x54, 0x7B, 0x94, 0x32, 0xA6, 0xC2, 0x23, 0x3D, 0xEE, 0x4C, 0x95, 0x0B, 0x42, 0xFA, 0xC3, 0x4E, 0x08, 0x2E, 0xA1, 0x66, 0x28, 0xD9, 0x24, 0xB2, 0x76, 0x5B, 0xA2, 0x49, 0x6D, 0x8B, 0xD1, 0x25, 0x72, 0xF8, 0xF6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xD4, 0xA4, 0x5C, 0xCC, 0x5D, 0x65, 0xB6, 0x92, 0x6C, 0x70, 0x48, 0x50, 0xFD, 0xED, 0xB9, 0xDA, 0x5E, 0x15, 0x46, 0x57, 0xA7, 0x8D, 0x9D, 0x84, 0x90, 0xD8, 0xAB, 0x00, 0x8C, 0xBC, 0xD3, 0x0A, 0xF7, 0xE4, 0x58, 0x05, 0xB8, 0xB3, 0x45, 0x06, 0xD0, 0x2C, 0x1E, 0x8F, 0xCA, 0x3F, 0x0F, 0x02, 0xC1, 0xAF, 0xBD, 0x03, 0x01, 0x13, 0x8A, 0x6B, 0x3A, 0x91, 0x11, 0x41, 0x4F, 0x67, 0xDC, 0xEA, 0x97, 0xF2, 0xCF, 0xCE, 0xF0, 0xB4, 0xE6, 0x73, 0x96, 0xAC, 0x74, 0x22, 0xE7, 0xAD, 0x35, 0x85, 0xE2, 0xF9, 0x37, 0xE8, 0x1C, 0x75, 0xDF, 0x6E, 0x47, 0xF1, 0x1A, 0x71, 0x1D, 0x29, 0xC5, 0x89, 0x6F, 0xB7, 0x62, 0x0E, 0xAA, 0x18, 0xBE, 0x1B, 0xFC, 0x56, 0x3E, 0x4B, 0xC6, 0xD2, 0x79, 0x20, 0x9A, 0xDB, 0xC0, 0xFE, 0x78, 0xCD, 0x5A, 0xF4, 0x1F, 0xDD, 0xA8, 0x33, 0x88, 0x07, 0xC7, 0x31, 0xB1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xEC, 0x5F, 0x60, 0x51, 0x7F, 0xA9, 0x19, 0xB5, 0x4A, 0x0D, 0x2D, 0xE5, 0x7A, 0x9F, 0x93, 0xC9, 0x9C, 0xEF, 0xA0, 0xE0, 0x3B, 0x4D, 0xAE, 0x2A, 0xF5, 0xB0, 0xC8, 0xEB, 0xBB, 0x3C, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2B, 0x04, 0x7E, 0xBA, 0x77, 0xD6, 0x26, 0xE1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0C, 0x7D, ) state = [ [251, 64, 182, 81], [146, 168, 33, 80], [199, 159, 195, 24], [64, 80, 182, 255], ] def sub_bytes(s, sbox=s_box): ??? print(sub_bytes(state, sbox=inv_s_box)) Solution 1 2 def sub_bytes(s, sbox=s_box): return bytes([sbox[x] for x in sum(s,[])]) \u003e sub_bytes(state, inv_s_box) b'crypto{l1n34rly}' flag: crypto{l1n34rly}\nDiffusion through Permutation We’ve seen how S-box substitution provides confusion. The other crucial property described by Shannon is “diffusion”. This relates to how every part of a cipher’s input should spread to every part of the output.\nSubstitution on its own creates non-linearity, however it doesn’t distribute it over the entire state. Without diffusion, the same byte in the same position would get the same transformations applied to it each round. This would allow cryptanalysts to attack each byte position in the state matrix separately. We need to alternate substitutions by scrambling the state (in an invertible way) so that substitutions applied on one byte influence all other bytes in the state. Each input into the next S-box then becomes a function of multiple bytes, meaning that with every round the algebraic complexity of the system increases enormously.\nThe ShiftRows and MixColumns steps combine to achieve this. They work together to ensure every byte affects every other byte in the state within just two rounds.\nShiftRows is the most simple transformation in AES. It keeps the first row of the state matrix the same. The second row is shifted over one column to the left, wrapping around. The third row is shifted two columns, the fourth row by three. Wikipedia puts it nicely: “the importance of this step is to avoid the columns being encrypted independently, in which case AES degenerates into four independent block ciphers.”\nMixColumns is more complex. It performs Matrix multiplication in Rijndael’s Galois field between the columns of the state matrix and a preset matrix. Each single byte of each column therefore affects all the bytes of the resulting column. The implementation details are nuanced; this page and Wikipedia do a good job of covering them.\nWe’ve provided code to perform MixColumns and the forward ShiftRows operation. After implementing inv_shift_rows, take the state, run inv_mix_columns on it, then inv_shift_rows, convert to bytes and you will have your flag.\nChallenge files:\ndiffusion.py file: diffusion.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 def shift_rows(s): s[0][1], s[1][1], s[2][1], s[3][1] = s[1][1], s[2][1], s[3][1], s[0][1] s[0][2], s[1][2], s[2][2], s[3][2] = s[2][2], s[3][2], s[0][2], s[1][2] s[0][3], s[1][3], s[2][3], s[3][3] = s[3][3], s[0][3], s[1][3], s[2][3] def inv_shift_rows(s): ??? # learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c xtime = lambda a: (((a \u003c\u003c 1) ^ 0x1B) \u0026 0xFF) if (a \u0026 0x80) else (a \u003c\u003c 1) def mix_single_column(a): # see Sec 4.1.2 in The Design of Rijndael t = a[0] ^ a[1] ^ a[2] ^ a[3] u = a[0] a[0] ^= t ^ xtime(a[0] ^ a[1]) a[1] ^= t ^ xtime(a[1] ^ a[2]) a[2] ^= t ^ xtime(a[2] ^ a[3]) a[3] ^= t ^ xtime(a[3] ^ u) def mix_columns(s): for i in range(4): mix_single_column(s[i]) def inv_mix_columns(s): # see Sec 4.1.3 in The Design of Rijndael for i in range(4): u = xtime(xtime(s[i][0] ^ s[i][2])) v = xtime(xtime(s[i][1] ^ s[i][3])) s[i][0] ^= u s[i][1] ^= v s[i][2] ^= u s[i][3] ^= v mix_columns(s) state = [ [108, 106, 71, 86], [96, 62, 38, 72], [42, 184, 92, 209], [94, 79, 8, 54], ] Solution 1 2 3 4 def inv_shift_rows(s): s[1][1], s[2][1], s[3][1], s[0][1] = s[0][1], s[1][1], s[2][1], s[3][1] s[2][2], s[3][2], s[0][2], s[1][2] = s[0][2], s[1][2], s[2][2], s[3][2] s[3][3], s[0][3], s[1][3], s[2][3] = s[0][3], s[1][3], s[2][3], s[3][3] \u003e inv_mix_columns(state) \u003e state [[99, 111, 102, 125], [116, 102, 82, 112], [49, 51, 121, 100], [115, 114, 123, 85]] \u003e inv_shift_rows(state) \u003e state [[99, 114, 121, 112], [116, 111, 123, 100], [49, 102, 102, 85], [115, 51, 82, 125]] \u003e matrix2bytes(state) b'crypto{d1ffUs3R}' flag: crypto{d1ffUs3R}\nBringing It All Together Apart from the KeyExpansion phase, we’ve sketched out all the components of AES. We’ve shown how SubBytes provides confusion and ShiftRows and MixColumns provide diffusion, and how these two properties work together to repeatedly circulate non-linear transformations over the state. Finally, AddRoundKey seeds the key into this substitution-permutation network, making the cipher a keyed permutation.\nDecryption involves performing the steps described in the “Structure of AES” challenge in reverse, applying the inverse operations. Note that the KeyExpansion still needs to be run first, and the round keys will be used in reverse order. AddRoundKey and its inverse are identical as XOR has the self-inverse property.\nWe’ve provided the key expansion code, and ciphertext that’s been properly encrypted by AES-128. Copy in all the building blocks you’ve coded so far, and complete the decrypt function that implements the steps shown in the diagram. The decrypted plaintext is the flag.\nYes, you can cheat on this challenge, but where’s the fun in that?\nThe code used in these exercises has been taken from Bo Zhu’s super simple Python AES implementation, so we’ve reproduced the license here.\nChallenge files:\naes_decrypt.py LICENSE Resources:\nRolling your own crypto: Everything you need to build AES from scratch file: aes_decrypt.py\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 N_ROUNDS = 10 key = b'\\xc3,\\\\\\xa6\\xb5\\x80^\\x0c\\xdb\\x8d\\xa5z*\\xb6\\xfe\\\\' ciphertext = b'\\xd1O\\x14j\\xa4+O\\xb6\\xa1\\xc4\\x08B)\\x8f\\x12\\xdd' def expand_key(master_key): \"\"\" Expands and returns a list of key matrices for the given master_key. \"\"\" # Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants r_con = ( 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1B, 0x36, 0x6C, 0xD8, 0xAB, 0x4D, 0x9A, 0x2F, 0x5E, 0xBC, 0x63, 0xC6, 0x97, 0x35, 0x6A, 0xD4, 0xB3, 0x7D, 0xFA, 0xEF, 0xC5, 0x91, 0x39, ) # Initialize round keys with raw key material. key_columns = bytes2matrix(master_key) iteration_size = len(master_key) // 4 # Each iteration has exactly as many columns as the key material. i = 1 while len(key_columns) \u003c (N_ROUNDS + 1) * 4: # Copy previous word. word = list(key_columns[-1]) # Perform schedule_core once every \"row\". if len(key_columns) % iteration_size == 0: # Circular shift. word.append(word.pop(0)) # Map to S-BOX. word = [s_box[b] for b in word] # XOR with first byte of R-CON, since the others bytes of R-CON are 0. word[0] ^= r_con[i] i += 1 elif len(master_key) == 32 and len(key_columns) % iteration_size == 4: # Run word through S-box in the fourth iteration when using a # 256-bit key. word = [s_box[b] for b in word] # XOR with equivalent word from previous iteration. word = bytes(i^j for i, j in zip(word, key_columns[-iteration_size])) key_columns.append(word) # Group key words in 4x4 byte matrices. return [key_columns[4*i : 4*(i+1)] for i in range(len(key_columns) // 4)] def decrypt(key, ciphertext): round_keys = expand_key(key) # Remember to start from the last round key and work backwards through them when decrypting # Convert ciphertext to state matrix # Initial add round key step for i in range(N_ROUNDS - 1, 0, -1): pass # Do round # Run final round (skips the InvMixColumns step) # Convert state matrix to plaintext return plaintext # print(decrypt(key, ciphertext)) Solution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 from Crypto.Util.number import bytes_to_long N_ROUNDS = 10 key = b'\\xc3,\\\\\\xa6\\xb5\\x80^\\x0c\\xdb\\x8d\\xa5z*\\xb6\\xfe\\\\' ciphertext = b'\\xd1O\\x14j\\xa4+O\\xb6\\xa1\\xc4\\x08B)\\x8f\\x12\\xdd' s_box = ( 0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76, 0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0, 0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15, 0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75, 0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84, 0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF, 0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8, 0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2, 0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73, 0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB, 0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79, 0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08, 0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A, 0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E, 0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF, 0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16, ) inv_s_box = ( 0x52, 0x09, 0x6A, 0xD5, 0x30, 0x36, 0xA5, 0x38, 0xBF, 0x40, 0xA3, 0x9E, 0x81, 0xF3, 0xD7, 0xFB, 0x7C, 0xE3, 0x39, 0x82, 0x9B, 0x2F, 0xFF, 0x87, 0x34, 0x8E, 0x43, 0x44, 0xC4, 0xDE, 0xE9, 0xCB, 0x54, 0x7B, 0x94, 0x32, 0xA6, 0xC2, 0x23, 0x3D, 0xEE, 0x4C, 0x95, 0x0B, 0x42, 0xFA, 0xC3, 0x4E, 0x08, 0x2E, 0xA1, 0x66, 0x28, 0xD9, 0x24, 0xB2, 0x76, 0x5B, 0xA2, 0x49, 0x6D, 0x8B, 0xD1, 0x25, 0x72, 0xF8, 0xF6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xD4, 0xA4, 0x5C, 0xCC, 0x5D, 0x65, 0xB6, 0x92, 0x6C, 0x70, 0x48, 0x50, 0xFD, 0xED, 0xB9, 0xDA, 0x5E, 0x15, 0x46, 0x57, 0xA7, 0x8D, 0x9D, 0x84, 0x90, 0xD8, 0xAB, 0x00, 0x8C, 0xBC, 0xD3, 0x0A, 0xF7, 0xE4, 0x58, 0x05, 0xB8, 0xB3, 0x45, 0x06, 0xD0, 0x2C, 0x1E, 0x8F, 0xCA, 0x3F, 0x0F, 0x02, 0xC1, 0xAF, 0xBD, 0x03, 0x01, 0x13, 0x8A, 0x6B, 0x3A, 0x91, 0x11, 0x41, 0x4F, 0x67, 0xDC, 0xEA, 0x97, 0xF2, 0xCF, 0xCE, 0xF0, 0xB4, 0xE6, 0x73, 0x96, 0xAC, 0x74, 0x22, 0xE7, 0xAD, 0x35, 0x85, 0xE2, 0xF9, 0x37, 0xE8, 0x1C, 0x75, 0xDF, 0x6E, 0x47, 0xF1, 0x1A, 0x71, 0x1D, 0x29, 0xC5, 0x89, 0x6F, 0xB7, 0x62, 0x0E, 0xAA, 0x18, 0xBE, 0x1B, 0xFC, 0x56, 0x3E, 0x4B, 0xC6, 0xD2, 0x79, 0x20, 0x9A, 0xDB, 0xC0, 0xFE, 0x78, 0xCD, 0x5A, 0xF4, 0x1F, 0xDD, 0xA8, 0x33, 0x88, 0x07, 0xC7, 0x31, 0xB1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xEC, 0x5F, 0x60, 0x51, 0x7F, 0xA9, 0x19, 0xB5, 0x4A, 0x0D, 0x2D, 0xE5, 0x7A, 0x9F, 0x93, 0xC9, 0x9C, 0xEF, 0xA0, 0xE0, 0x3B, 0x4D, 0xAE, 0x2A, 0xF5, 0xB0, 0xC8, 0xEB, 0xBB, 0x3C, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2B, 0x04, 0x7E, 0xBA, 0x77, 0xD6, 0x26, 0xE1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0C, 0x7D, ) def expand_key(master_key): \"\"\" Expands and returns a list of key matrices for the given master_key. \"\"\" # Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants r_con = ( 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1B, 0x36, 0x6C, 0xD8, 0xAB, 0x4D, 0x9A, 0x2F, 0x5E, 0xBC, 0x63, 0xC6, 0x97, 0x35, 0x6A, 0xD4, 0xB3, 0x7D, 0xFA, 0xEF, 0xC5, 0x91, 0x39, ) # Initialize round keys with raw key material. key_columns = bytes2matrix(master_key) iteration_size = len(master_key) // 4 # Each iteration has exactly as many columns as the key material. i = 1 while len(key_columns) \u003c (N_ROUNDS + 1) * 4: # Copy previous word. word = list(key_columns[-1]) # Perform schedule_core once every \"row\". if len(key_columns) % iteration_size == 0: # Circular shift. word.append(word.pop(0)) # Map to S-BOX. word = [s_box[b] for b in word] # XOR with first byte of R-CON, since the others bytes of R-CON are 0. word[0] ^= r_con[i] i += 1 elif len(master_key) == 32 and len(key_columns) % iteration_size == 4: # Run word through S-box in the fourth iteration when using a # 256-bit key. word = [s_box[b] for b in word] # XOR with equivalent word from previous iteration. word = bytes(i^j for i, j in zip(word, key_columns[-iteration_size])) key_columns.append(word) # Group key words in 4x4 byte matrices. return [key_columns[4*i : 4*(i+1)] for i in range(len(key_columns) // 4)] def bytes2matrix(text): \"\"\" Converts a 16-byte array into a 4x4 matrix. \"\"\" return [list(text[i:i+4]) for i in range(0, len(text), 4)] def matrix2bytes(matrix): return bytes(sum(matrix, [])) def add_round_key(s, k): return [[s_val^k_val for s_val, k_val in zip(s_lst,k_lst)] for s_lst, k_lst in zip(s, k)] def inv_shift_rows(s): s[1][1], s[2][1], s[3][1], s[0][1] = s[0][1], s[1][1], s[2][1], s[3][1] s[2][2], s[3][2], s[0][2], s[1][2] = s[0][2], s[1][2], s[2][2], s[3][2] s[3][3], s[0][3], s[1][3], s[2][3] = s[0][3], s[1][3], s[2][3], s[3][3] def sub_bytes(s, sbox=s_box): return [[int(sbox[a]) for a in row] for row in s] # learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c xtime = lambda a: (((a \u003c\u003c 1) ^ 0x1B) \u0026 0xFF) if (a \u0026 0x80) else (a \u003c\u003c 1) def mix_single_column(a): # see Sec 4.1.2 in The Design of Rijndael t = a[0] ^ a[1] ^ a[2] ^ a[3] u = a[0] a[0] ^= t ^ xtime(a[0] ^ a[1]) a[1] ^= t ^ xtime(a[1] ^ a[2]) a[2] ^= t ^ xtime(a[2] ^ a[3]) a[3] ^= t ^ xtime(a[3] ^ u) def mix_columns(s): for i in range(4): mix_single_column(s[i]) def inv_mix_columns(s): # see Sec 4.1.3 in The Design of Rijndael for i in range(4): u = xtime(xtime(s[i][0] ^ s[i][2])) v = xtime(xtime(s[i][1] ^ s[i][3])) s[i][0] ^= u s[i][1] ^= v s[i][2] ^= u s[i][3] ^= v mix_columns(s) def decrypt(key, ciphertext): round_keys = expand_key(key) # Remember to start from the last round key and work backwards through them when decrypting # Convert ciphertext to state matrix state = bytes2matrix(ciphertext) # Initial add round key step state = add_round_key(state, round_keys[-1]) for i in range(N_ROUNDS - 1, 0, -1): inv_shift_rows(state) state = sub_bytes(state, inv_s_box) state = add_round_key(state, round_keys[i]) inv_mix_columns(state) # Run final round (skips the InvMixColumns step) inv_shift_rows(state) state = sub_bytes(state, inv_s_box) state = add_round_key(state, round_keys[0]) # Convert state matrix to plaintext plaintext = matrix2bytes(state) return plaintext \u003e print(decrypt(key,ciphertext)) b'crypto{MYAES128}' flag: crypto{MYAES128}\nModes of Operation Starter The previous set of challenges showed how AES performs a keyed permutation on a block of data. In practice, we need to encrypt messages much longer than a single block. A mode of operation describes how to use a cipher like AES on longer messages.\nAll modes have serious weaknesses when used incorrectly. The challenges in this category take you to a different section of the website where you can interact with APIs and exploit those weaknesses. Get yourself acquainted with the interface and use it to take your next flag!\nPlay at http://aes.cryptohack.org/block_cipher_starter\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 from Crypto.Cipher import AES KEY = ? FLAG = ? @chal.route('/block_cipher_starter/decrypt//') def decrypt(ciphertext): ciphertext = bytes.fromhex(ciphertext) cipher = AES.new(KEY, AES.MODE_ECB) try: decrypted = cipher.decrypt(ciphertext) except ValueError as e: return {\"error\": str(e)} return {\"plaintext\": decrypted.hex()} @chal.route('/block_cipher_starter/encrypt_flag/') def encrypt_flag(): cipher = AES.new(KEY, AES.MODE_ECB) encrypted = cipher.encrypt(FLAG.encode()) return {\"ciphertext\": encrypted.hex()} Solution Visit http://aes.cryptohack.org/block_cipher_starter Visit https://aes.cryptohack.org//block_cipher_starter/encrypt_flag/ {\"ciphertext\":\"1b36a55b687f21f73fe0bed721c1a5c305716a9a1c1745d50a39e0ae8f2fb9ba\"} Decrypt ciphertext 4. Hex Decode\nflag: crypto{bl0ck_c1ph3r5_4r3_f457_!}\nPasswords as Keys It is essential that keys in symmetric-key algorithms are random bytes, instead of passwords or other predictable data. The random bytes should be generated using a cryptographically-secure pseudorandom number generator (CSPRNG). If the keys are predictable in any way, then the security level of the cipher is reduced and it may be possible for an attacker who gets access to the ciphertext to decrypt it.\nJust because a key looks like it is formed of random bytes, does not mean that it necessarily is. In this case the key has been derived from a simple password using a hashing function, which makes the ciphertext crackable.\nFor this challenge you may script your HTTP requests to the endpoints, or alternatively attack the ciphertext offline. Good luck!\nPlay at http://aes.cryptohack.org/passwords_as_keys\nSolution 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import requests import hashlib from time import sleep from Crypto.Cipher import AES # Get Ciphertext url = 'http://aes.cryptohack.org/passwords_as_keys' r = requests.get(f\"{url}/encrypt_flag\") ct = r.json()['ciphertext'] print(f\"Ciphertext: {ct}\") # Get word list r = requests.get(\"https://gist.githubusercontent.com/wchargin/8927565/raw/d9783627c731268fb2935a731a618aa8e95cf465/words\") words = r.content.split(b'\\n') # Brute password for word in words: key = hashlib.md5(word).digest() cipher = AES.new(key, AES.MODE_ECB) try: pt = cipher.decrypt(bytes.fromhex(ct)) if b\"crypto{\" in pt: print(f\"Plaintext: {pt.decode()}\") except: continue flag: crypto{k3y5__r__n07__p455w0rdz?}\nECB Oracle ECB is the most simple mode, with each plaintext block encrypted entirely independently. In this case, your input is prepended to the secret flag and encrypted and that’s it. We don’t even provide a decrypt function. Perhaps you don’t need a padding oracle when you have an “ECB oracle”?\nPlay at http://aes.cryptohack.org/ecb_oracle\nsource code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad KEY = ? FLAG = ? @chal.route('/ecb_oracle/encrypt//') def encrypt(plaintext): plaintext = bytes.fromhex(plaintext) padded = pad(plaintext + FLAG.encode(), 16) cipher = AES.new(KEY, AES.MODE_ECB) try: encrypted = cipher.encrypt(padded) except ValueError as e: return {\"error\": str(e)} return {\"ciphertext\": encrypted.hex()} Solution This problem was a bit difficult for me to solve. The first step in understanding it was looking more into how the pad function actually works in the backend of pycryptodome. This is more easily demonstrated through an example.\n\u003e from Crypto.Util.Padding import pad \u003e [pad(b'?'*i, 16) for i in range(1,17)] # We want to see 1-16, so we set the range to 17 since it doesn't include the last value. [b'?\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f\\x0f', b'??\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e\\x0e', b'???\\r\\r\\r\\r\\r\\r\\r\\r\\r\\r\\r\\r\\r', b'????\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c', b'?????\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b', b'??????\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n', b'???????\\t\\t\\t\\t\\t\\t\\t\\t\\t', b'????????\\x08\\x08\\x08\\x08\\x08\\x08\\x08\\x08', b'?????????\\x07\\x07\\x07\\x07\\x07\\x07\\x07', b'??????????\\x06\\x06\\x06\\x06\\x06\\x06', b'???????????\\x05\\x05\\x05\\x05\\x05', b'????????????\\x04\\x04\\x04\\x04', b'?????????????\\x03\\x03\\x03', b'??????????????\\x02\\x02', b'???????????????\\x01', b'????????????????\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10'] When the amount of ?’s we provide is less than the block_size of 16, padding will be added. However, if 16 bytes (or ?’s) are provided, the pad function will create a new block (2 blocks of 16 bytes, totalling to 32 bytes in length). Therefore, if we give a bunch of garbage, we can leak the length of the flag.\nTL;DR: we can measure the amount of bytes we send in alongside the amount of blocks that get generated to determine the flag length. So, if we send in x-1 bytes and have 2 blocks (32 bytes total), then send in x bytes and have 3 blocks (48 bytes total), we know:\nflag_length = 2 blocks * 16 bytes/block - x bytes -\u003e 32 bytes - x bytes Time to script…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 import string import requests def encrypt(plainhex): r = requests.get(f\"https://aes.cryptohack.org/ecb_oracle/encrypt/{plainhex}\") return bytes.fromhex(r.json()['ciphertext']) ciphers = [] for i in range(1,17): garbage = i*b'?'.hex() ct = encrypt(garbage) ciphers.append(ct) print(f\"Garbage ({len(garbage)//2} bytes): {bytes.fromhex(garbage).decode()}\") print(f\"Ciphertext ({len(ct.hex())//2} bytes): {ct.hex()}\") Garbage (1 bytes): ? Ciphertext (32 bytes): 341dd0bf293efbc386baa0450a9f7a121d91b08cbd0a3ff55d6225e7f2cb1fe1 Garbage (2 bytes): ?? Ciphertext (32 bytes): c7404a9325a0b5bd6f663638f86f6d14133cfd98ad547f6a1dae2cdccac36bda Garbage (3 bytes): ??? Ciphertext (32 bytes): 1e46817be36af1d0d263fed68ab2b3b440b0f25961b3330f4880effcdd1d9372 Garbage (4 bytes): ???? Ciphertext (32 bytes): 700b70280d82306f6b577da0e70914003775fe4513f275eeb4a20548db2b1372 Garbage (5 bytes): ????? Ciphertext (32 bytes): 043d72cd0c91d09ee654031196f6a203f0aaaa9734688f65f110768d242965f2 Garbage (6 bytes): ?????? Ciphertext (32 bytes): dd90d7562c5d17c5ff323f1a024483749f1d9ea23fc3f0857e80d9254d053b99 Garbage (7 bytes): ??????? Ciphertext (48 bytes): d32166eeaa47575cf04ae32526b6006c1f227170511203bbb211a703905f9e5128ae38bc1312435b814108836328262a Garbage (8 bytes): ???????? Ciphertext (48 bytes): 9eaa653b150e6218b56d887fb99d00f21206ed1975a928fe0813952f43171080b6800d8b95758d3bf16d0f75ca9f38e8 Garbage (9 bytes): ????????? Ciphertext (48 bytes): 7a987178f47d51a9d650fdd312580bf50e5eaa21119c631ae8304d9d2c1ef310593c7d830f153c8a4b7f41c116065d73 Garbage (10 bytes): ?????????? Ciphertext (48 bytes): 66a3abc4b4b82020586064a647d7fa75e1434b90c1f8633f9818265dfff40e08c9dd5d6a2703d3beb1def6e688083f3a Garbage (11 bytes): ??????????? Ciphertext (48 bytes): 0fd571c8e551af19d186a30c9b3c02034cc4a08218ed3d4aead3c49d2c49e5b5ed8db991b61458ce267a94b891a472fb Garbage (12 bytes): ???????????? Ciphertext (48 bytes): 12d380f787bdbc1bc7a4b8619f45609af2f1b66e09e912eff09384648f453f3db11abf8572ab7a34347ada3026bf0911 Garbage (13 bytes): ????????????? Ciphertext (48 bytes): ae7db02691622c4562866713fa013c5cee268318401e6c194260a8ffa3d2df71190f2b09607b5764d577d4d5569b9059 Garbage (14 bytes): ?????????????? Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc7bd036db83a337f9f4f867dd5691e1f7fd105ad78e0e6fa84f694743dd59cc94 Garbage (15 bytes): ??????????????? Ciphertext (48 bytes): eed4350b17297b157330c401581ac453a6734bcc83eace3a107321af7775026b7d715d5c670622e24c462ae108288f25 Garbage (16 bytes): ???????????????? Ciphertext (48 bytes): da572df43b1a6bd8ad66da297d64c445bea177bc81b326eef475195dee42ba6c2eb3958aa4a3fa0d49789f5152a4eed2 As shown above, we can see that when 7 bytes of garbage are sent in, a new block is made. This meas our flag must be 32-7 = 25 bytes.\n\u003e flag_len = [len(i.hex())//2 - x - 2 for x, (i,j) in enumerate(zip(ciphers,ciphers[1:])) if len(j.hex())\u003elen(i.hex())][0] 25 From here, we know that the flag will need be held within 2 blocks. If we want to leak the flag, we will need 4 blocks total (2 for garbage and leaking + 2 for holding the flag and padding) totalling to 64 bytes. To make more sense of how this works, let’s start with leaking a few bytes manually.\nFrom previous challenges, let’s assume the flag does adhere to the format crypto{...}. When scripting, its easy to check all possible bytes, but since this is an example and its manual, let’s be smart and guess the first byte is c. From above, we can see:\nGarbage (15 bytes): ??????????????? Ciphertext (48 bytes): eed4350b17297b157330c401581ac453a6734bcc83eace3a107321af7775026b7d715d5c670622e24c462ae108288f25 As we remember, each block is 16 bytes. Since we only sent in 15 bytes and this plaintext is prepended to the flag, we know that the next byte (16th byte) has to be the first byte of the flag. We also know that each block is independent and will have its own ciphertext. This means that if the 16th byte is the same as the first byte of the flag, we will get the same ciphertext for block 1. For example:\nGarbage (15 bytes): ??????????????? Ciphertext (48 bytes): eed4350b17297b157330c401581ac453 a6734bcc83eace3a107321af7775026b 7d715d5c670622e24c462ae108288f25 Garbage (15 bytes) + 'c' (1 byte): ???????????????c Ciphertext (48 bytes): eed4350b17297b157330c401581ac453 bea177bc81b326eef475195dee42ba6c 2eb3958aa4a3fa0d49789f5152a4eed2 As we can see, the first block of ciphertext for each payload is the same. eed4350b17297b157330c401581ac453 == eed4350b17297b157330c401581ac453\nLet’s try it again for the sake of clarity. Now that we know the first letter of the flag is c, we need to reduce the amount of garbage we send in to 14 bytes (14 + len('c') = 15) so there is only byte we need to guess. We can try r due to the flag format.\nGarbage (14 bytes) + 'c' (1 byte): ??????????????c Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc 7bd036db83a337f9f4f867dd5691e1f7 fd105ad78e0e6fa84f694743dd59cc94 Garbage (14 bytes) + 'c' (1 byte) + 'r' (1 byte): ??????????????cr Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc bea177bc81b326eef475195dee42ba6c 2eb3958aa4a3fa0d49789f5152a4eed2 That’s it basically. Just script this process!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 import string import requests def encrypt(plainhex): r = requests.get(f\"https://aes.cryptohack.org/ecb_oracle/encrypt/{plainhex}\") return bytes.fromhex(r.json()['ciphertext']) ciphers = [] for i in range(1,17): garbage = i*b'?'.hex() ct = encrypt(garbage) ciphers.append(ct) print(f\"Garbage ({len(garbage)//2} bytes): {bytes.fromhex(garbage).decode()}\") print(f\"Ciphertext ({len(ct.hex())//2} bytes): {ct.hex()}\") # Calculate flag length (easier visually) flag_len = [len(i.hex())//2 - x - 2 for x, (i,j) in enumerate(zip(ciphers,ciphers[1:])) if len(j.hex())\u003elen(i.hex())][0] # Put likely strings and letters at the beginning - remove duplicates alpha = list(dict.fromkeys(\"crypto{eainshr_}\" + string.ascii_lowercase + string.digits + string.ascii_uppercase)) flag = b\"\" print(\"Brute forcing flag...\\n\") for i in range(31, 31-flag_len, -1): for char in alpha: char = char.encode() ct = encrypt((i*b\"?\"+flag+char).hex())[:32] exp = encrypt((i*b\"?\").hex())[:32] if ct == exp: flag += char print(f\"{char.decode()}\", flush=True, end='') break flag: crypto{p3n6u1n5_h473_3cb}\nECB CBC WTF Here you can encrypt in CBC but only decrypt in ECB. That shouldn’t be a weakness because they’re different modes… right?\nPlay at http://aes.cryptohack.org/ecbcbcwtf\nsource code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 from Crypto.Cipher import AES KEY = ? FLAG = ? @chal.route('/ecbcbcwtf/decrypt//') def decrypt(ciphertext): ciphertext = bytes.fromhex(ciphertext) cipher = AES.new(KEY, AES.MODE_ECB) try: decrypted = cipher.decrypt(ciphertext) except ValueError as e: return {\"error\": str(e)} return {\"plaintext\": decrypted.hex()} @chal.route('/ecbcbcwtf/encrypt_flag/') def encrypt_flag(): iv = os.urandom(16) cipher = AES.new(KEY, AES.MODE_CBC, iv) encrypted = cipher.encrypt(FLAG.encode()) ciphertext = iv.hex() + encrypted.hex() return {\"ciphertext\": ciphertext} Solution To solve this challenge, we first need to look at the differences between CBC and ECB.\nThis boils down to the following:\nECB Encryption: c1=p1^key c2=p2^key Decryption: p1=c1^key p2=c2^key CBC Encryption: c1=p1^key^iv c2=c1^p2 Decryption: p1=c1^key^iv p2=c1^c2 Since iv in this case is random, we will not be able to decrypt p1. However, we can decrypt p2 and p3.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import requests from pwn import xor def request_ct(): \"\"\" gets ciphertext of flag \"\"\" return requests.get(\"https://aes.cryptohack.org/ecbcbcwtf/encrypt_flag/\").json()['ciphertext'] def request_pt(ct): \"\"\" gets plaintext of given ciphertext \"\"\" return requests.get(\"https://aes.cryptohack.org/ecbcbcwtf/decrypt/\"+ct).json()['plaintext'] def blockify(txt, size): \"\"\" turns text into list of blocks \"\"\" return [txt[i:i+size] for i in range(0, len(txt), size)] ct = request_ct() pt = request_pt(ct) ct_blocks = blockify(ct, 32) # 16 bytes * 2 since hex! flag = '' for c,p in zip(ct_blocks, ct_blocks[1:]): current_block_ct = bytes.fromhex(c) next_block_pt = bytes.fromhex(request_pt(p)) flag += xor(current_block_ct, next_block_pt).decode() \u003e print(flag) crypto{3cb_5uck5_4v01d_17_!!!!!} Alternate solution(s): flag: crypto{3cb_5uck5_4v01d_17_!!!!!}\nFlipping Cookie You can get a cookie for my website, but it won’t help you read the flag… I think.\nPlay at http://aes.cryptohack.org/flipping_cookie\nsource code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 from Crypto.Cipher import AES import os from Crypto.Util.Padding import pad, unpad from datetime import datetime, timedelta KEY = ? FLAG = ? @chal.route('/flipping_cookie/check_admin///') def check_admin(cookie, iv): cookie = bytes.fromhex(cookie) iv = bytes.fromhex(iv) try: cipher = AES.new(KEY, AES.MODE_CBC, iv) decrypted = cipher.decrypt(cookie) unpadded = unpad(decrypted, 16) except ValueError as e: return {\"error\": str(e)} if b\"admin=True\" in unpadded.split(b\";\"): return {\"flag\": FLAG} else: return {\"error\": \"Only admin can read the flag\"} @chal.route('/flipping_cookie/get_cookie/') def get_cookie(): expires_at = (datetime.today() + timedelta(days=1)).strftime(\"%s\") cookie = f\"admin=False;expiry={expires_at}\".encode() iv = os.urandom(16) padded = pad(cookie, 16) cipher = AES.new(KEY, AES.MODE_CBC, iv) encrypted = cipher.encrypt(padded) ciphertext = iv.hex() + encrypted.hex() return {\"cookie\": ciphertext} Solution To solve this problem, turning CBC decryption into a system of equations makes the rest trivial. As we previously covered (see the images above), CBC decryption can be broken down like so:\nEncryption: p1 ^ iv ^ key = c1 p2 ^ c1 ^ key = c2 p3 ^ c2 ^ key = c3 Decryption: c1 ^ key ^ iv = p1 c1 ^ d(c2) = p2 c2 ^ d(c3) = p3 From the source code, we are given iv, the ciphertext, and the plaintext. However, it turns out we only really need iv and p1 to solve. This is because our goal is only to change admin=False to admin=True through our own malicious iv payload. Let’s change these terms to something more readily understandable:\n1. p1 ^ iv ^ key = c1 -\u003e given_pt ^ given_iv ^ tmp_key = tmp_ct c1 ^ key ^ iv = p1 -\u003e tmp_ct ^ tmp_key ^ iv_payload = pt_payload ________________________________________________________________________________ 2. (given_pt ^ given_iv ^ tmp_key) ^ tmp_key ^ iv_payload = pt_payload ________________________________________________________________________________ 3. given_pt ^ given_iv ^ iv_payload = pt_payload ________________________________________________________________________________ 4. iv_payload = pt_payload ^ given_iv ^ given_pt So all we have to do is XOR our desired plaintext admin=True... with the given iv and the given plaintext admin=False... to get our iv_payload. Then, we can just send this payload to the server and get the flag!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import requests from pwn import xor def get_ciphertext(): r = requests.get(\"http://aes.cryptohack.org/flipping_cookie/get_cookie\") return r.json()['cookie'] def check_admin(cookie,iv): r = requests.get(f\"http://aes.cryptohack.org/flipping_cookie/check_admin/{cookie}/{iv}\") return r.json() ct = bytes.fromhex(get_ciphertext()) iv = ct[:16] cookie = ct[16:].hex() pt = b'admin=False;expiry='[:16] pt_payload = b'admin=True;expiry='[:16] iv_payload = xor(pt_payload, pt, iv).hex() print(check_admin(cookie, iv_payload)['flag']) flag: crypto{4u7h3n71c4710n_15_3553n714l}\nSymmetry Some block cipher modes, such as OFB, CTR, or CFB, turn a block cipher into a stream cipher. The idea behind stream ciphers is to produce a pseudorandom keystream which is then XORed with the plaintext. One advantage of stream ciphers is that they can work of plaintext of arbitrary length, with no padding required.\nOFB is an obscure cipher mode, with no real benefits these days over using CTR. This challenge introduces an unusual property of OFB.\nPlay at http://aes.cryptohack.org/symmetry\nsource code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 from Crypto.Cipher import AES KEY = ? FLAG = ? @chal.route('/symmetry/encrypt///') def encrypt(plaintext, iv): plaintext = bytes.fromhex(plaintext) iv = bytes.fromhex(iv) if len(iv) != 16: return {\"error\": \"IV length must be 16\"} cipher = AES.new(KEY, AES.MODE_OFB, iv) encrypted = cipher.encrypt(plaintext) ciphertext = encrypted.hex() return {\"ciphertext\": ciphertext} @chal.route('/symmetry/encrypt_flag/') def encrypt_flag(): iv = os.urandom(16) cipher = AES.new(KEY, AES.MODE_OFB, iv) encrypted = cipher.encrypt(FLAG.encode()) ciphertext = iv.hex() + encrypted.hex() return {\"ciphertext\": ciphertext} Solution After checking Wikipedia, I realized the encryption and decryption methods are the same for OFB! We’ve got all we need. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 import requests def get_ciphertext(): r = requests.get(\"https://aes.cryptohack.org/symmetry/encrypt_flag/\") return r.json()['ciphertext'] def get_flag(ct, iv): r = requests.get(f\"https://aes.cryptohack.org/symmetry/encrypt/{ct}/{iv}\") return r.json()['ciphertext'] ct = bytes.fromhex(get_ciphertext()) iv = ct[:16].hex() ct = ct[16:].hex() print(bytes.fromhex(get_flag(ct, iv)).decode()) flag: crypto{0fb_15_5ymm37r1c4l_!!!11!}\nBean Counter I’ve struggled to get PyCrypto’s counter mode doing what I want, so I’ve turned ECB mode into CTR myself. My counter can go both upwards and downwards to throw off cryptanalysts! There’s no chance they’ll be able to read my picture.\nPlay at http://aes.cryptohack.org/bean_counter\nsource code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 from Crypto.Cipher import AES KEY = ? class StepUpCounter(object): def __init__(self, value=os.urandom(16), step_up=False): self.value = value.hex() self.step = 1 self.stup = step_up def increment(self): if self.stup: self.newIV = hex(int(self.value, 16) + self.step) else: self.newIV = hex(int(self.value, 16) - self.stup) self.value = self.newIV[2:len(self.newIV)] return bytes.fromhex(self.value.zfill(32)) def __repr__(self): self.increment() return self.value @chal.route('/bean_counter/encrypt/') def encrypt(): cipher = AES.new(KEY, AES.MODE_ECB) ctr = StepUpCounter() out = [] with open(\"challenge_files/bean_flag.png\", 'rb') as f: block = f.read(16) while block: keystream = cipher.encrypt(ctr.increment()) xored = [a^b for a, b in zip(block, keystream)] out.append(bytes(xored).hex()) block = f.read(16) return {\"encrypted\": ''.join(out)} Solution The trick to this solution is realizing that we know plaintext (png header) and ciphertext (given) of the first block. We can use this to calculate the key and then ultimately decrypt the rest of the ciphertext.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import requests from pwn import xor png_header = bytes.fromhex('89504e470d0a1a0a0000000d49484452') def get_ciphertext(): r = requests.get(\"https://aes.cryptohack.org/bean_counter/encrypt/\") return r.json()['encrypted'] ct = bytes.fromhex(get_ciphertext()) key = xor(png_header, ct[:16]) pt = xor(ct, key) with open('bean.png', 'wb') as f: f.write(pt) [ bean.png ] ","wordCount":"7182","inLanguage":"en","image":"https://cryptohack.org/static/img/courses/symmetric.png","datePublished":"2022-11-08T22:07:33-07:00","dateModified":"2022-11-08T22:07:33-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://woadey.lol/posts/cryptohack/symmetric_cryptography/"},"publisher":{"@type":"Organization","name":"woadey","logo":{"@type":"ImageObject","url":"https://woadey.lol/favicon/pink_trans_bg/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://woadey.lol/ accesskey=h title="oadey (Alt + H)"><img src=/images/pink_hu5661c188f24668226bb80c6208008ab1_117796_0x32_resize_q75_h2_box.webp height=32 width=32 alt=logo aria-label=logo>
oadey</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://woadey.lol/posts/ title=posts><span>posts</span></a></li><li><a href=https://woadey.lol/categories/ title=categories><span>categories</span></a></li><li><a href=https://woadey.lol/tags/ title=tags><span>tags</span></a></li><li><a href=https://woadey.lol/archives/ title=archives><span>archives</span></a></li><li><a href=https://woadey.lol/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://woadey.lol/>home</a>&nbsp;»&nbsp;<a href=https://woadey.lol/posts/>posts</a></div><h1 class=post-title>CryptoHack: Symmetric Cryptography</h1><div class=post-description>Writeups for CryptoHack&rsquo;s <a href=https://cryptohack.org/courses/symmetric/course_details/ title="Symmetric Cryptography Course" target=_blank rel="nofollow noopener">Symmetric Cryptography Course</a></div><div class=post-meta><span title='2022-11-08 22:07:33 -0700 -0700'>November 8, 2022</span>&nbsp;·&nbsp;34 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#keyed-permutations>Keyed Permutations</a><ul><li><a href=#solution>Solution</a></li></ul></li><li><a href=#resisting-bruteforce>Resisting Bruteforce</a><ul><li><a href=#solution-1>Solution</a></li></ul></li><li><a href=#structure-of-aes>Structure of AES</a><ul><li><a href=#solution-2>Solution</a></li></ul></li><li><a href=#round-keys>Round Keys</a><ul><li><a href=#solution-3>Solution</a></li></ul></li><li><a href=#confusion-through-substitution>Confusion through Substitution</a><ul><li><a href=#solution-4>Solution</a></li></ul></li><li><a href=#diffusion-through-permutation>Diffusion through Permutation</a><ul><li><a href=#solution-5>Solution</a></li></ul></li><li><a href=#bringing-it-all-together>Bringing It All Together</a><ul><li><a href=#solution-6>Solution</a></li></ul></li><li><a href=#modes-of-operation-starter>Modes of Operation Starter</a><ul><li><a href=#solution-7>Solution</a></li></ul></li><li><a href=#passwords-as-keys>Passwords as Keys</a><ul><li><a href=#solution-8>Solution</a></li></ul></li><li><a href=#ecb-oracle>ECB Oracle</a><ul><li><a href=#solution-9>Solution</a></li></ul></li><li><a href=#ecb-cbc-wtf>ECB CBC WTF</a><ul><li><a href=#solution-10>Solution</a></li></ul></li><li><a href=#flipping-cookie>Flipping Cookie</a><ul><li><a href=#solution-11>Solution</a></li></ul></li><li><a href=#symmetry>Symmetry</a><ul><li><a href=#solution-12>Solution</a></li></ul></li><li><a href=#bean-counter>Bean Counter</a><ul><li><a href=#solution-13>Solution</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=keyed-permutations>Keyed Permutations<a hidden class=anchor aria-hidden=true href=#keyed-permutations>#</a></h2><blockquote><p>AES, like all good block ciphers, performs a &ldquo;keyed permutation&rdquo;. This means that it maps every possible input block to a unique output block, with a key determining which permutation to perform.</p><p>Using the same key, the permutation can be performed in reverse, mapping the output block back to the original input block. It is important that there is a one-to-one correspondence between input and output blocks, otherwise we wouldn&rsquo;t be able to rely on the ciphertext to decrypt back to the same plaintext we started with.
What is the mathematical term for a one-to-one correspondence?</p></blockquote><h3 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h3><p><strong>flag:</strong> <code>crypto{bijection}</code></p><h2 id=resisting-bruteforce>Resisting Bruteforce<a hidden class=anchor aria-hidden=true href=#resisting-bruteforce>#</a></h2><blockquote><p>If a block cipher is secure, there should be no way for an attacker to distinguish the output of AES from a <a href=https://en.wikipedia.org/wiki/Pseudorandom_permutation title="random permutation" target=_blank rel="nofollow noopener">random permutation</a> of bits. Furthermore, there should be no better way to undo the permutation than simply bruteforcing every possible key. That&rsquo;s why academics consider a cipher theoretically &ldquo;broken&rdquo; if they can find an attack that takes fewer steps to perform than bruteforcing the key, even if that attack is practically infeasible.</p><p>It turns out that there is <a href=https://en.wikipedia.org/wiki/Biclique_attack title="an attack" target=_blank rel="nofollow noopener">an attack</a> on AES that&rsquo;s better than bruteforce, but only slightly – it lowers the security level of AES-128 down to 126.1 bits, and hasn&rsquo;t been improved on for over 8 years. Given the large &ldquo;security margin&rdquo; provided by 128 bits, and the lack of improvements despite extensive study, it&rsquo;s not considered a credible risk to the security of AES. But yes, in a very narrow sense, it &ldquo;breaks&rdquo; AES.</p><p>Finally, while quantum computers have the potential to completely break popular public-key cryptosystems like RSA via <a href=https://en.wikipedia.org/wiki/Shor%27s_algorithm title="Shor&rsquo;s algorithm" target=_blank rel="nofollow noopener">Shor&rsquo;s algorithm</a>, they are thought to only cut in half the security level of symmetric cryptosystems via <a href=https://en.wikipedia.org/wiki/Grover%27s_algorithm title="Grover&rsquo;s algorithm" target=_blank rel="nofollow noopener">Grover&rsquo;s algorithm</a>. This is one reason why people recommend using AES-256, despite it being less performant, as it would still provide a very adequate 128 bits of security in a quantum future.</p><p>What is the name for the best single-key attack against AES?</p></blockquote><h3 id=solution-1>Solution<a hidden class=anchor aria-hidden=true href=#solution-1>#</a></h3><p><strong>flag:</strong> <code>crypto{biclique}</code></p><h2 id=structure-of-aes>Structure of AES<a hidden class=anchor aria-hidden=true href=#structure-of-aes>#</a></h2><blockquote><p>To achieve a keyed permutation that is infeasible to invert without the key, AES applies a large number of ad-hoc mixing operations on the input. This is in stark contrast to public-key cryptosystems like RSA, which are based on elegant individual mathematical problems. AES is much less elegant, but it&rsquo;s very fast.</p><p>At a high level, AES-128 begins with a &ldquo;key schedule&rdquo; and then runs 10 rounds over a state. The starting state is just the plaintext block that we want to encrypt, represented as a 4x4 matrix of bytes. Over the course of the 10 rounds, the state is repeatedly modified by a number of invertible transformations.</p><p>Here&rsquo;s an overview of the phases of AES encryption:</p><ol><li><strong>KeyExpansion</strong> or Key Schedule</li></ol><p>From the 128 bit key, 11 separate 128 bit &ldquo;round keys&rdquo; are derived: one to be used in each AddRoundKey step.</p><ol start=2><li><strong>Initial key addition</strong></li></ol><p><em>AddRoundKey</em> - the bytes of the first round key are XOR&rsquo;d with the bytes of the state.</p><ol start=3><li><strong>Round</strong> - this phase is looped 10 times, for 9 main rounds plus one &ldquo;final round&rdquo;</li></ol><p> a) <em>SubBytes</em> - each byte of the state is substituted for a different byte according to a lookup table (&ldquo;S-box&rdquo;).</p><p> b) <em>ShiftRows</em> - the last three rows of the state matrix are transposed—shifted over a column or two or three.</p><p> c) <em>MixColumns</em> - matrix multiplication is performed on the columns of the state, combining the four bytes in each column. This is skipped in the final round.</p><p> d) <em>AddRoundKey</em> - the bytes of the current round key are XOR&rsquo;d with the bytes of the state.</p><p>Included is a <code>bytes2matrix</code> function for converting our initial plaintext block into a state matrix. Write a <code>matrix2bytes</code> function to turn that matrix back into bytes, and submit the resulting plaintext as the flag.</p><p>Challenge files:</p><ul><li>matrix.py</li></ul><p>Resources:</p><ul><li><a href="https://www.youtube.com/watch?v=gP4PqVGudtg" title="YouTube: AES Rijndael Cipher explained as a Flash animation" target=_blank rel="nofollow noopener">YouTube: AES Rijndael Cipher explained as a Flash animation</a></li></ul></blockquote><p><em>file: matrix.py</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>bytes2matrix</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Converts a 16-byte array into a 4x4 matrix.  &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>text</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>4</span><span class=p>])</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>),</span> <span class=mi>4</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Converts a 4x4 matrix into a 16-byte array.  &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=err>????</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>matrix</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>99</span><span class=p>,</span> <span class=mi>114</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>112</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>116</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>105</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>110</span><span class=p>,</span> <span class=mi>109</span><span class=p>,</span> <span class=mi>97</span><span class=p>,</span> <span class=mi>116</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>114</span><span class=p>,</span> <span class=mi>105</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=mi>125</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-2>Solution<a hidden class=anchor aria-hidden=true href=#solution-2>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>chr</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=k>for</span> <span class=n>lst</span> <span class=ow>in</span> <span class=n>matrix</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>lst</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>crypto</span><span class=p>{</span><span class=n>inmatrix</span><span class=p>}</span>
</span></span></code></pre></div><p>Alternative solution(s):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># source: CryptoHack user @Robin_Jadoul</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Converts a 4x4 matrix into a 16-byte array.  &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=p>[]))</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>flag:</strong> <code>crypto{inmatrix}</code></p><h2 id=round-keys>Round Keys<a hidden class=anchor aria-hidden=true href=#round-keys>#</a></h2><blockquote><p>We&rsquo;re going to skip over the finer details of the KeyExpansion phase for now. The main point is that it takes in our 16 byte key and produces 11 4x4 matrices called &ldquo;round keys&rdquo; derived from our initial key. These round keys allow AES to get extra mileage out of the single key that we provided.</p><p>The <strong>initial key addition</strong> phase, which is next, has a single <em>AddRoundKey</em> step. The <em>AddRoundKey</em> step is straightforward: it XORs the current state with the current round key.</p><p><em>AddRoundKey</em> also occurs as the final step of each round. <em>AddRoundKey</em> is what makes AES a &ldquo;keyed permutation&rdquo; rather than just a permutation. It&rsquo;s the only part of AES where the key is mixed into the state, but is crucial for determining the permutation that occurs.</p><p>As you&rsquo;ve seen in previous challenges, XOR is an easily invertible operation if you know the key, but tough to undo if you don&rsquo;t. Now imagine trying to recover plaintext which has been XOR&rsquo;d with 11 different keys, and heavily jumbled between each XOR operation with a series of substitution and transposition ciphers. That&rsquo;s kinda what AES does! And we&rsquo;ll see just how effective the jumbling is in the next few challenges.</p><p>Complete the <code>add_round_key</code> function, then use the <code>matrix2bytes</code> function to get your next flag.</p><p>Challenge files:</p><ul><li>add_round_key.py</li></ul></blockquote><p><em>file: add_round_key.py</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>206</span><span class=p>,</span> <span class=mi>243</span><span class=p>,</span> <span class=mi>61</span><span class=p>,</span> <span class=mi>34</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>171</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>93</span><span class=p>,</span> <span class=mi>31</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>16</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>91</span><span class=p>,</span> <span class=mi>108</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>150</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>194</span><span class=p>,</span> <span class=mi>51</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>round_key</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>173</span><span class=p>,</span> <span class=mi>129</span><span class=p>,</span> <span class=mi>68</span><span class=p>,</span> <span class=mi>82</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>223</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>38</span><span class=p>,</span> <span class=mi>109</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>32</span><span class=p>,</span> <span class=mi>189</span><span class=p>,</span> <span class=mi>53</span><span class=p>,</span> <span class=mi>8</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>253</span><span class=p>,</span> <span class=mi>48</span><span class=p>,</span> <span class=mi>187</span><span class=p>,</span> <span class=mi>78</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_round_key</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=err>???</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_key</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-3>Solution<a hidden class=anchor aria-hidden=true href=#solution-3>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_round_key</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[[</span><span class=n>x</span><span class=o>^</span><span class=n>y</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>s</span><span class=p>,[]),</span> <span class=nb>sum</span><span class=p>(</span><span class=n>k</span><span class=p>,[]))][</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>4</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>16</span><span class=p>,</span><span class=mi>4</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><p>or</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_round_key</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[[</span><span class=n>s_val</span><span class=o>^</span><span class=n>k_val</span> <span class=k>for</span> <span class=n>s_val</span><span class=p>,</span> <span class=n>k_val</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>s_lst</span><span class=p>,</span><span class=n>k_lst</span><span class=p>)]</span> <span class=k>for</span> <span class=n>s_lst</span><span class=p>,</span> <span class=n>k_lst</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>)]</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=mi>99</span><span class=p>,</span> <span class=mi>114</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>112</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>116</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>114</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>48</span><span class=p>,</span> <span class=mi>117</span><span class=p>,</span> <span class=mi>110</span><span class=p>,</span> <span class=mi>100</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>107</span><span class=p>,</span> <span class=mi>51</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>125</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>matrix2bytes</span><span class=p>(</span><span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_key</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>crypto</span><span class=p>{</span><span class=n>r0undk3y</span><span class=p>}</span>
</span></span></code></pre></div><p><strong>flag:</strong> <code>crypto{r0undk3y}</code></p><h2 id=confusion-through-substitution>Confusion through Substitution<a hidden class=anchor aria-hidden=true href=#confusion-through-substitution>#</a></h2><blockquote><p>The first step of each AES round is SubBytes. This involves taking each byte of the state matrix and substituting it for a different byte in a preset 16x16 lookup table. The lookup table is called a &ldquo;Substitution box&rdquo; or &ldquo;S-box&rdquo; for short, and can be perplexing at first sight. Let&rsquo;s break it down.</p><p>In 1945 American mathematician Claude Shannon published a groundbreaking paper on Information Theory. It identified &ldquo;confusion&rdquo; as an essential property of a secure cipher. &ldquo;Confusion&rdquo; means that the relationship between the ciphertext and the key should be as complex as possible. Given just a ciphertext, there should be no way to learn anything about the key.</p><p>If a cipher has poor confusion, it is possible to express a relationship between ciphertext, key, and plaintext as a linear function. For instance, in a Caesar cipher, <code>ciphertext = plaintext + key</code>. That&rsquo;s an obvious relation, which is easy to reverse. More complicated linear transformations can be solved using techniques like Gaussian elimination. Even low-degree polynomials, e.g. an equation like <code>x^4 + 51x^3 + x</code>, can be solved efficiently using <a href=https://math.stackexchange.com/a/1078515 title="algebraic methods" target=_blank rel="nofollow noopener">algebraic methods</a>. However, the higher the degree of a polynomial, generally the harder it becomes to solve – it can only be approximated by a larger and larger amount of linear functions.</p><p>The main purpose of the S-box is to transform the input in a way that is resistant to being approximated by linear functions. S-boxes are aiming for high non-linearity, and while AES&rsquo;s one is not perfect, it&rsquo;s pretty close. The fast lookup in an S-box is a shortcut for performing a very nonlinear function on the input bytes. This function involves taking the modular inverse in the <a href=https://www.samiam.org/galois.html title="Galois field 2**8" target=_blank rel="nofollow noopener">Galois field 2**8</a> and then applying an affine transformation which has been tweaked for maximum confusion. The simplest way to express the function is through the following high-degree polynomial:</p><p>diagram showing S-Box equation</p><p>To make the S-box, the function has been calculated on all input values from 0x00 to 0xff and the outputs put in the lookup table.</p><p>Implement <code>sub_bytes</code>, send the state matrix through the inverse S-box and then convert it to bytes to get the flag.</p><p>Challenge files:</p><ul><li>sbox.py</li></ul></blockquote><p><em>file: sbox.py</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>s_box</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x7C</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0x7B</span><span class=p>,</span> <span class=mh>0xF2</span><span class=p>,</span> <span class=mh>0x6B</span><span class=p>,</span> <span class=mh>0x6F</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0xFE</span><span class=p>,</span> <span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xCA</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0xC9</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xA2</span><span class=p>,</span> <span class=mh>0xAF</span><span class=p>,</span> <span class=mh>0x9C</span><span class=p>,</span> <span class=mh>0xA4</span><span class=p>,</span> <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xC0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x3F</span><span class=p>,</span> <span class=mh>0xF7</span><span class=p>,</span> <span class=mh>0xCC</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0xA5</span><span class=p>,</span> <span class=mh>0xE5</span><span class=p>,</span> <span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xE2</span><span class=p>,</span> <span class=mh>0xEB</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0xB2</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x2C</span><span class=p>,</span> <span class=mh>0x1A</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span> <span class=mh>0x6E</span><span class=p>,</span> <span class=mh>0x5A</span><span class=p>,</span> <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x3B</span><span class=p>,</span> <span class=mh>0xD6</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0xD1</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0xED</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xFC</span><span class=p>,</span> <span class=mh>0xB1</span><span class=p>,</span> <span class=mh>0x5B</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span> <span class=mh>0xCB</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x4A</span><span class=p>,</span> <span class=mh>0x4C</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0xCF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xD0</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span> <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0xFB</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x7F</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0x9F</span><span class=p>,</span> <span class=mh>0xA8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0xA3</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0x8F</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span> <span class=mh>0x9D</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xF5</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0xB6</span><span class=p>,</span> <span class=mh>0xDA</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0xF3</span><span class=p>,</span> <span class=mh>0xD2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xCD</span><span class=p>,</span> <span class=mh>0x0C</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0xEC</span><span class=p>,</span> <span class=mh>0x5F</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0xC4</span><span class=p>,</span> <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0x3D</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x5D</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x4F</span><span class=p>,</span> <span class=mh>0xDC</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0x2A</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0xEE</span><span class=p>,</span> <span class=mh>0xB8</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0xDE</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0x0B</span><span class=p>,</span> <span class=mh>0xDB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE0</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0x3A</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x5C</span><span class=p>,</span> <span class=mh>0xC2</span><span class=p>,</span> <span class=mh>0xD3</span><span class=p>,</span> <span class=mh>0xAC</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0xE4</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE7</span><span class=p>,</span> <span class=mh>0xC8</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0x6D</span><span class=p>,</span> <span class=mh>0x8D</span><span class=p>,</span> <span class=mh>0xD5</span><span class=p>,</span> <span class=mh>0x4E</span><span class=p>,</span> <span class=mh>0xA9</span><span class=p>,</span> <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span> <span class=mh>0xEA</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x7A</span><span class=p>,</span> <span class=mh>0xAE</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xBA</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span> <span class=mh>0x2E</span><span class=p>,</span> <span class=mh>0x1C</span><span class=p>,</span> <span class=mh>0xA6</span><span class=p>,</span> <span class=mh>0xB4</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0xDD</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x1F</span><span class=p>,</span> <span class=mh>0x4B</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x8B</span><span class=p>,</span> <span class=mh>0x8A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x3E</span><span class=p>,</span> <span class=mh>0xB5</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0xF6</span><span class=p>,</span> <span class=mh>0x0E</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xB9</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span> <span class=mh>0x9E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE1</span><span class=p>,</span> <span class=mh>0xF8</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0xD9</span><span class=p>,</span> <span class=mh>0x8E</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x9B</span><span class=p>,</span> <span class=mh>0x1E</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0xE9</span><span class=p>,</span> <span class=mh>0xCE</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x8C</span><span class=p>,</span> <span class=mh>0xA1</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x0D</span><span class=p>,</span> <span class=mh>0xBF</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x2D</span><span class=p>,</span> <span class=mh>0x0F</span><span class=p>,</span> <span class=mh>0xB0</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0xBB</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inv_s_box</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span> <span class=mh>0xD5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0xA5</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xBF</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0xA3</span><span class=p>,</span> <span class=mh>0x9E</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0xF3</span><span class=p>,</span> <span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0xFB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7C</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x9B</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x8E</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0xC4</span><span class=p>,</span> <span class=mh>0xDE</span><span class=p>,</span> <span class=mh>0xE9</span><span class=p>,</span> <span class=mh>0xCB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x7B</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0xA6</span><span class=p>,</span> <span class=mh>0xC2</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x3D</span><span class=p>,</span> <span class=mh>0xEE</span><span class=p>,</span> <span class=mh>0x4C</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0x0B</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>,</span> <span class=mh>0x4E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x2E</span><span class=p>,</span> <span class=mh>0xA1</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xD9</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0xB2</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span> <span class=mh>0x5B</span><span class=p>,</span> <span class=mh>0xA2</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x6D</span><span class=p>,</span> <span class=mh>0x8B</span><span class=p>,</span> <span class=mh>0xD1</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xF8</span><span class=p>,</span> <span class=mh>0xF6</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span> <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xA4</span><span class=p>,</span> <span class=mh>0x5C</span><span class=p>,</span> <span class=mh>0xCC</span><span class=p>,</span> <span class=mh>0x5D</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0xB6</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0xED</span><span class=p>,</span> <span class=mh>0xB9</span><span class=p>,</span> <span class=mh>0xDA</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x8D</span><span class=p>,</span> <span class=mh>0x9D</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x8C</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0xD3</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0xF7</span><span class=p>,</span> <span class=mh>0xE4</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0xB8</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xD0</span><span class=p>,</span> <span class=mh>0x2C</span><span class=p>,</span> <span class=mh>0x1E</span><span class=p>,</span> <span class=mh>0x8F</span><span class=p>,</span> <span class=mh>0xCA</span><span class=p>,</span> <span class=mh>0x3F</span><span class=p>,</span> <span class=mh>0x0F</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span> <span class=mh>0xAF</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0x8A</span><span class=p>,</span> <span class=mh>0x6B</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x3A</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x4F</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0xDC</span><span class=p>,</span> <span class=mh>0xEA</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0xF2</span><span class=p>,</span> <span class=mh>0xCF</span><span class=p>,</span> <span class=mh>0xCE</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>,</span> <span class=mh>0xB4</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0xAC</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0xE7</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0xE2</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0x1C</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span> <span class=mh>0x6E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0x1A</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x6F</span><span class=p>,</span> <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x0E</span><span class=p>,</span> <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xFC</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0x3E</span><span class=p>,</span> <span class=mh>0x4B</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0xD2</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span> <span class=mh>0xDB</span><span class=p>,</span> <span class=mh>0xC0</span><span class=p>,</span> <span class=mh>0xFE</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0xCD</span><span class=p>,</span> <span class=mh>0x5A</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x1F</span><span class=p>,</span> <span class=mh>0xDD</span><span class=p>,</span> <span class=mh>0xA8</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0xB1</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xEC</span><span class=p>,</span> <span class=mh>0x5F</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0x7F</span><span class=p>,</span> <span class=mh>0xA9</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0xB5</span><span class=p>,</span> <span class=mh>0x4A</span><span class=p>,</span> <span class=mh>0x0D</span><span class=p>,</span> <span class=mh>0x2D</span><span class=p>,</span> <span class=mh>0xE5</span><span class=p>,</span> <span class=mh>0x7A</span><span class=p>,</span> <span class=mh>0x9F</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0xC9</span><span class=p>,</span> <span class=mh>0x9C</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0xE0</span><span class=p>,</span> <span class=mh>0x3B</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0xAE</span><span class=p>,</span> <span class=mh>0x2A</span><span class=p>,</span> <span class=mh>0xF5</span><span class=p>,</span> <span class=mh>0xB0</span><span class=p>,</span> <span class=mh>0xC8</span><span class=p>,</span> <span class=mh>0xEB</span><span class=p>,</span> <span class=mh>0xBB</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0xBA</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0xD6</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0xE1</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x0C</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>251</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>182</span><span class=p>,</span> <span class=mi>81</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>146</span><span class=p>,</span> <span class=mi>168</span><span class=p>,</span> <span class=mi>33</span><span class=p>,</span> <span class=mi>80</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>199</span><span class=p>,</span> <span class=mi>159</span><span class=p>,</span> <span class=mi>195</span><span class=p>,</span> <span class=mi>24</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>64</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>182</span><span class=p>,</span> <span class=mi>255</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub_bytes</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>sbox</span><span class=o>=</span><span class=n>s_box</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=err>???</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>sub_bytes</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>sbox</span><span class=o>=</span><span class=n>inv_s_box</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-4>Solution<a hidden class=anchor aria-hidden=true href=#solution-4>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub_bytes</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>sbox</span><span class=o>=</span><span class=n>s_box</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>([</span><span class=n>sbox</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>sum</span><span class=p>(</span><span class=n>s</span><span class=p>,[])])</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>sub_bytes</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>inv_s_box</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;crypto</span><span class=si>{l1n34rly}</span><span class=s1>&#39;</span>
</span></span></code></pre></div><p><strong>flag:</strong> <code>crypto{l1n34rly}</code></p><h2 id=diffusion-through-permutation>Diffusion through Permutation<a hidden class=anchor aria-hidden=true href=#diffusion-through-permutation>#</a></h2><blockquote><p>We&rsquo;ve seen how S-box substitution provides confusion. The other crucial property described by Shannon is &ldquo;diffusion&rdquo;. This relates to how every part of a cipher&rsquo;s input should spread to every part of the output.</p><p>Substitution on its own creates non-linearity, however it doesn&rsquo;t distribute it over the entire state. Without diffusion, the same byte in the same position would get the same transformations applied to it each round. This would allow cryptanalysts to attack each byte position in the state matrix separately. We need to alternate substitutions by scrambling the state (in an invertible way) so that substitutions applied on one byte influence all other bytes in the state. Each input into the next S-box then becomes a function of multiple bytes, meaning that with every round the algebraic complexity of the system increases enormously.</p><p>The <em>ShiftRows</em> and <em>MixColumns</em> steps combine to achieve this. They work together to ensure every byte affects every other byte in the state within just two rounds.</p><p><em>ShiftRows</em> is the most simple transformation in AES. It keeps the first row of the state matrix the same. The second row is shifted over one column to the left, wrapping around. The third row is shifted two columns, the fourth row by three. Wikipedia puts it nicely: &ldquo;the importance of this step is to avoid the columns being encrypted independently, in which case AES degenerates into four independent block ciphers.&rdquo;</p><p><em>MixColumns</em> is more complex. It performs Matrix multiplication in Rijndael&rsquo;s Galois field between the columns of the state matrix and a preset matrix. Each single byte of each column therefore affects all the bytes of the resulting column. The implementation details are nuanced; <a href=https://www.samiam.org/mix-column.html title="this page" target=_blank rel="nofollow noopener">this page</a> and <a href=https://en.wikipedia.org/wiki/Rijndael_MixColumns title=Wikipedia target=_blank rel="nofollow noopener">Wikipedia</a> do a good job of covering them.</p><p>We&rsquo;ve provided code to perform <em>MixColumns</em> and the forward <em>ShiftRows</em> operation. After implementing <code>inv_shift_rows</code>, take the state, run <code>inv_mix_columns</code> on it, then <code>inv_shift_rows</code>, convert to bytes and you will have your flag.</p><p>Challenge files:</p><ul><li>diffusion.py</li></ul></blockquote><p><em>file: diffusion.py</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>shift_rows</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_shift_rows</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=err>???</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c</span>
</span></span><span class=line><span class=cl><span class=n>xtime</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>a</span><span class=p>:</span> <span class=p>(((</span><span class=n>a</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=mh>0x1B</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span> <span class=k>else</span> <span class=p>(</span><span class=n>a</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_single_column</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># see Sec 4.1.2 in The Design of Rijndael</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>^</span> <span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_single_column</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># see Sec 4.1.3 in The Design of Rijndael</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>xtime</span><span class=p>(</span><span class=n>xtime</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>xtime</span><span class=p>(</span><span class=n>xtime</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>3</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>u</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>^=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>^=</span> <span class=n>u</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>^=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>108</span><span class=p>,</span> <span class=mi>106</span><span class=p>,</span> <span class=mi>71</span><span class=p>,</span> <span class=mi>86</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>96</span><span class=p>,</span> <span class=mi>62</span><span class=p>,</span> <span class=mi>38</span><span class=p>,</span> <span class=mi>72</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>42</span><span class=p>,</span> <span class=mi>184</span><span class=p>,</span> <span class=mi>92</span><span class=p>,</span> <span class=mi>209</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=mi>94</span><span class=p>,</span> <span class=mi>79</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>54</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-5>Solution<a hidden class=anchor aria-hidden=true href=#solution-5>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_shift_rows</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>inv_mix_columns</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>state</span>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=mi>99</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>125</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>116</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>82</span><span class=p>,</span> <span class=mi>112</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>49</span><span class=p>,</span> <span class=mi>51</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>100</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>115</span><span class=p>,</span> <span class=mi>114</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>85</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>inv_shift_rows</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>state</span>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=mi>99</span><span class=p>,</span> <span class=mi>114</span><span class=p>,</span> <span class=mi>121</span><span class=p>,</span> <span class=mi>112</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>116</span><span class=p>,</span> <span class=mi>111</span><span class=p>,</span> <span class=mi>123</span><span class=p>,</span> <span class=mi>100</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>49</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>85</span><span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=mi>115</span><span class=p>,</span> <span class=mi>51</span><span class=p>,</span> <span class=mi>82</span><span class=p>,</span> <span class=mi>125</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>matrix2bytes</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;crypto</span><span class=si>{d1ffUs3R}</span><span class=s1>&#39;</span>
</span></span></code></pre></div><p><strong>flag:</strong> <code>crypto{d1ffUs3R}</code></p><h2 id=bringing-it-all-together>Bringing It All Together<a hidden class=anchor aria-hidden=true href=#bringing-it-all-together>#</a></h2><blockquote><p>Apart from the <strong>KeyExpansion</strong> phase, we&rsquo;ve sketched out all the components of AES. We&rsquo;ve shown how <em>SubBytes</em> provides confusion and <em>ShiftRows</em> and <em>MixColumns</em> provide diffusion, and how these two properties work together to repeatedly circulate non-linear transformations over the state. Finally, <em>AddRoundKey</em> seeds the key into this substitution-permutation network, making the cipher a keyed permutation.</p><p>Decryption involves performing the steps described in the &ldquo;Structure of AES&rdquo; challenge in reverse, applying the inverse operations. Note that the KeyExpansion still needs to be run first, and the round keys will be used in reverse order. <em>AddRoundKey</em> and its inverse are identical as XOR has the self-inverse property.</p><p>We&rsquo;ve provided the key expansion code, and ciphertext that&rsquo;s been properly encrypted by AES-128. Copy in all the building blocks you&rsquo;ve coded so far, and complete the <code>decrypt</code> function that implements the steps shown in the diagram. The decrypted plaintext is the flag.</p><p>Yes, you can cheat on this challenge, but where&rsquo;s the fun in that?</p><p>The code used in these exercises has been taken from Bo Zhu&rsquo;s super simple Python AES implementation, so we&rsquo;ve reproduced the license here.</p><p>Challenge files:</p><ul><li>aes_decrypt.py</li><li>LICENSE</li></ul><p>Resources:</p><ul><li><a href=https://github.com/francisrstokes/githublog/blob/main/2022/6/15/rolling-your-own-crypto-aes.md title="Rolling your own crypto: Everything you need to build AES from scratch" target=_blank rel="nofollow noopener">Rolling your own crypto: Everything you need to build AES from scratch</a></li></ul></blockquote><p><em>file: aes_decrypt.py</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>N_ROUNDS</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span>        <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xc3</span><span class=s1>,</span><span class=se>\\\xa6\xb5\x80</span><span class=s1>^</span><span class=se>\x0c\xdb\x8d\xa5</span><span class=s1>z*</span><span class=se>\xb6\xfe\\</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>ciphertext</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xd1</span><span class=s1>O</span><span class=se>\x14</span><span class=s1>j</span><span class=se>\xa4</span><span class=s1>+O</span><span class=se>\xb6\xa1\xc4\x08</span><span class=s1>B)</span><span class=se>\x8f\x12\xdd</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>expand_key</span><span class=p>(</span><span class=n>master_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Expands and returns a list of key matrices for the given master_key.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants</span>
</span></span><span class=line><span class=cl>    <span class=n>r_con</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialize round keys with raw key material.</span>
</span></span><span class=line><span class=cl>    <span class=n>key_columns</span> <span class=o>=</span> <span class=n>bytes2matrix</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iteration_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Each iteration has exactly as many columns as the key material.</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>N_ROUNDS</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Copy previous word.</span>
</span></span><span class=line><span class=cl>        <span class=n>word</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>key_columns</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Perform schedule_core once every &#34;row&#34;.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>%</span> <span class=n>iteration_size</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Circular shift.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>word</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># Map to S-BOX.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span> <span class=o>=</span> <span class=p>[</span><span class=n>s_box</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>word</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># XOR with first byte of R-CON, since the others bytes of R-CON are 0.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>r_con</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span> <span class=o>==</span> <span class=mi>32</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>%</span> <span class=n>iteration_size</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Run word through S-box in the fourth iteration when using a</span>
</span></span><span class=line><span class=cl>            <span class=c1># 256-bit key.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span> <span class=o>=</span> <span class=p>[</span><span class=n>s_box</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>word</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># XOR with equivalent word from previous iteration.</span>
</span></span><span class=line><span class=cl>        <span class=n>word</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>i</span><span class=o>^</span><span class=n>j</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>word</span><span class=p>,</span> <span class=n>key_columns</span><span class=p>[</span><span class=o>-</span><span class=n>iteration_size</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>key_columns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Group key words in 4x4 byte matrices.</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>key_columns</span><span class=p>[</span><span class=mi>4</span><span class=o>*</span><span class=n>i</span> <span class=p>:</span> <span class=mi>4</span><span class=o>*</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span> <span class=o>=</span> <span class=n>expand_key</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=c1># Remember to start from the last round key and work backwards through them when decrypting</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert ciphertext to state matrix</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Initial add round key step</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_ROUNDS</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span> <span class=c1># Do round</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Run final round (skips the InvMixColumns step)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert state matrix to plaintext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plaintext</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># print(decrypt(key, ciphertext))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-6>Solution<a hidden class=anchor aria-hidden=true href=#solution-6>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.number</span> <span class=kn>import</span> <span class=n>bytes_to_long</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>N_ROUNDS</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key</span>        <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xc3</span><span class=s1>,</span><span class=se>\\\xa6\xb5\x80</span><span class=s1>^</span><span class=se>\x0c\xdb\x8d\xa5</span><span class=s1>z*</span><span class=se>\xb6\xfe\\</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>ciphertext</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xd1</span><span class=s1>O</span><span class=se>\x14</span><span class=s1>j</span><span class=se>\xa4</span><span class=s1>+O</span><span class=se>\xb6\xa1\xc4\x08</span><span class=s1>B)</span><span class=se>\x8f\x12\xdd</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s_box</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x7C</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0x7B</span><span class=p>,</span> <span class=mh>0xF2</span><span class=p>,</span> <span class=mh>0x6B</span><span class=p>,</span> <span class=mh>0x6F</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0xFE</span><span class=p>,</span> <span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xCA</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0xC9</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xA2</span><span class=p>,</span> <span class=mh>0xAF</span><span class=p>,</span> <span class=mh>0x9C</span><span class=p>,</span> <span class=mh>0xA4</span><span class=p>,</span> <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xC0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x3F</span><span class=p>,</span> <span class=mh>0xF7</span><span class=p>,</span> <span class=mh>0xCC</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0xA5</span><span class=p>,</span> <span class=mh>0xE5</span><span class=p>,</span> <span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xE2</span><span class=p>,</span> <span class=mh>0xEB</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0xB2</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x2C</span><span class=p>,</span> <span class=mh>0x1A</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span> <span class=mh>0x6E</span><span class=p>,</span> <span class=mh>0x5A</span><span class=p>,</span> <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x3B</span><span class=p>,</span> <span class=mh>0xD6</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0xD1</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0xED</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xFC</span><span class=p>,</span> <span class=mh>0xB1</span><span class=p>,</span> <span class=mh>0x5B</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span> <span class=mh>0xCB</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x4A</span><span class=p>,</span> <span class=mh>0x4C</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0xCF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xD0</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span> <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0xFB</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x7F</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0x9F</span><span class=p>,</span> <span class=mh>0xA8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0xA3</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0x8F</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span> <span class=mh>0x9D</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xF5</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0xB6</span><span class=p>,</span> <span class=mh>0xDA</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0xF3</span><span class=p>,</span> <span class=mh>0xD2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xCD</span><span class=p>,</span> <span class=mh>0x0C</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0xEC</span><span class=p>,</span> <span class=mh>0x5F</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0xC4</span><span class=p>,</span> <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0x3D</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x5D</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x4F</span><span class=p>,</span> <span class=mh>0xDC</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0x2A</span><span class=p>,</span> <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0xEE</span><span class=p>,</span> <span class=mh>0xB8</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0xDE</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0x0B</span><span class=p>,</span> <span class=mh>0xDB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE0</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0x3A</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x5C</span><span class=p>,</span> <span class=mh>0xC2</span><span class=p>,</span> <span class=mh>0xD3</span><span class=p>,</span> <span class=mh>0xAC</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0xE4</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE7</span><span class=p>,</span> <span class=mh>0xC8</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0x6D</span><span class=p>,</span> <span class=mh>0x8D</span><span class=p>,</span> <span class=mh>0xD5</span><span class=p>,</span> <span class=mh>0x4E</span><span class=p>,</span> <span class=mh>0xA9</span><span class=p>,</span> <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span> <span class=mh>0xEA</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x7A</span><span class=p>,</span> <span class=mh>0xAE</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xBA</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span> <span class=mh>0x2E</span><span class=p>,</span> <span class=mh>0x1C</span><span class=p>,</span> <span class=mh>0xA6</span><span class=p>,</span> <span class=mh>0xB4</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0xDD</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x1F</span><span class=p>,</span> <span class=mh>0x4B</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x8B</span><span class=p>,</span> <span class=mh>0x8A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x3E</span><span class=p>,</span> <span class=mh>0xB5</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0xF6</span><span class=p>,</span> <span class=mh>0x0E</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xB9</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span> <span class=mh>0x9E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xE1</span><span class=p>,</span> <span class=mh>0xF8</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0xD9</span><span class=p>,</span> <span class=mh>0x8E</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x9B</span><span class=p>,</span> <span class=mh>0x1E</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0xE9</span><span class=p>,</span> <span class=mh>0xCE</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x8C</span><span class=p>,</span> <span class=mh>0xA1</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x0D</span><span class=p>,</span> <span class=mh>0xBF</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x2D</span><span class=p>,</span> <span class=mh>0x0F</span><span class=p>,</span> <span class=mh>0xB0</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0xBB</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inv_s_box</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span> <span class=mh>0xD5</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0xA5</span><span class=p>,</span> <span class=mh>0x38</span><span class=p>,</span> <span class=mh>0xBF</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mh>0xA3</span><span class=p>,</span> <span class=mh>0x9E</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0xF3</span><span class=p>,</span> <span class=mh>0xD7</span><span class=p>,</span> <span class=mh>0xFB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7C</span><span class=p>,</span> <span class=mh>0xE3</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x9B</span><span class=p>,</span> <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0x34</span><span class=p>,</span> <span class=mh>0x8E</span><span class=p>,</span> <span class=mh>0x43</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0xC4</span><span class=p>,</span> <span class=mh>0xDE</span><span class=p>,</span> <span class=mh>0xE9</span><span class=p>,</span> <span class=mh>0xCB</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x7B</span><span class=p>,</span> <span class=mh>0x94</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>,</span> <span class=mh>0xA6</span><span class=p>,</span> <span class=mh>0xC2</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x3D</span><span class=p>,</span> <span class=mh>0xEE</span><span class=p>,</span> <span class=mh>0x4C</span><span class=p>,</span> <span class=mh>0x95</span><span class=p>,</span> <span class=mh>0x0B</span><span class=p>,</span> <span class=mh>0x42</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0xC3</span><span class=p>,</span> <span class=mh>0x4E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x2E</span><span class=p>,</span> <span class=mh>0xA1</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x28</span><span class=p>,</span> <span class=mh>0xD9</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0xB2</span><span class=p>,</span> <span class=mh>0x76</span><span class=p>,</span> <span class=mh>0x5B</span><span class=p>,</span> <span class=mh>0xA2</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x6D</span><span class=p>,</span> <span class=mh>0x8B</span><span class=p>,</span> <span class=mh>0xD1</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0xF8</span><span class=p>,</span> <span class=mh>0xF6</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x86</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x98</span><span class=p>,</span> <span class=mh>0x16</span><span class=p>,</span> <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xA4</span><span class=p>,</span> <span class=mh>0x5C</span><span class=p>,</span> <span class=mh>0xCC</span><span class=p>,</span> <span class=mh>0x5D</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0xB6</span><span class=p>,</span> <span class=mh>0x92</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0xFD</span><span class=p>,</span> <span class=mh>0xED</span><span class=p>,</span> <span class=mh>0xB9</span><span class=p>,</span> <span class=mh>0xDA</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x46</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0xA7</span><span class=p>,</span> <span class=mh>0x8D</span><span class=p>,</span> <span class=mh>0x9D</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x90</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x8C</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0xD3</span><span class=p>,</span> <span class=mh>0x0A</span><span class=p>,</span> <span class=mh>0xF7</span><span class=p>,</span> <span class=mh>0xE4</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0xB8</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x45</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xD0</span><span class=p>,</span> <span class=mh>0x2C</span><span class=p>,</span> <span class=mh>0x1E</span><span class=p>,</span> <span class=mh>0x8F</span><span class=p>,</span> <span class=mh>0xCA</span><span class=p>,</span> <span class=mh>0x3F</span><span class=p>,</span> <span class=mh>0x0F</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span> <span class=mh>0xAF</span><span class=p>,</span> <span class=mh>0xBD</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x13</span><span class=p>,</span> <span class=mh>0x8A</span><span class=p>,</span> <span class=mh>0x6B</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x3A</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x4F</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0xDC</span><span class=p>,</span> <span class=mh>0xEA</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0xF2</span><span class=p>,</span> <span class=mh>0xCF</span><span class=p>,</span> <span class=mh>0xCE</span><span class=p>,</span> <span class=mh>0xF0</span><span class=p>,</span> <span class=mh>0xB4</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x96</span><span class=p>,</span> <span class=mh>0xAC</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x22</span><span class=p>,</span> <span class=mh>0xE7</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0xE2</span><span class=p>,</span> <span class=mh>0xF9</span><span class=p>,</span> <span class=mh>0x37</span><span class=p>,</span> <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0x1C</span><span class=p>,</span> <span class=mh>0x75</span><span class=p>,</span> <span class=mh>0xDF</span><span class=p>,</span> <span class=mh>0x6E</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0x1A</span><span class=p>,</span> <span class=mh>0x71</span><span class=p>,</span> <span class=mh>0x1D</span><span class=p>,</span> <span class=mh>0x29</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0x6F</span><span class=p>,</span> <span class=mh>0xB7</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x0E</span><span class=p>,</span> <span class=mh>0xAA</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xFC</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0x3E</span><span class=p>,</span> <span class=mh>0x4B</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0xD2</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span> <span class=mh>0xDB</span><span class=p>,</span> <span class=mh>0xC0</span><span class=p>,</span> <span class=mh>0xFE</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0xCD</span><span class=p>,</span> <span class=mh>0x5A</span><span class=p>,</span> <span class=mh>0xF4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x1F</span><span class=p>,</span> <span class=mh>0xDD</span><span class=p>,</span> <span class=mh>0xA8</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span> <span class=mh>0x88</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x31</span><span class=p>,</span> <span class=mh>0xB1</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0xEC</span><span class=p>,</span> <span class=mh>0x5F</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x51</span><span class=p>,</span> <span class=mh>0x7F</span><span class=p>,</span> <span class=mh>0xA9</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0xB5</span><span class=p>,</span> <span class=mh>0x4A</span><span class=p>,</span> <span class=mh>0x0D</span><span class=p>,</span> <span class=mh>0x2D</span><span class=p>,</span> <span class=mh>0xE5</span><span class=p>,</span> <span class=mh>0x7A</span><span class=p>,</span> <span class=mh>0x9F</span><span class=p>,</span> <span class=mh>0x93</span><span class=p>,</span> <span class=mh>0xC9</span><span class=p>,</span> <span class=mh>0x9C</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0xE0</span><span class=p>,</span> <span class=mh>0x3B</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0xAE</span><span class=p>,</span> <span class=mh>0x2A</span><span class=p>,</span> <span class=mh>0xF5</span><span class=p>,</span> <span class=mh>0xB0</span><span class=p>,</span> <span class=mh>0xC8</span><span class=p>,</span> <span class=mh>0xEB</span><span class=p>,</span> <span class=mh>0xBB</span><span class=p>,</span> <span class=mh>0x3C</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x17</span><span class=p>,</span> <span class=mh>0x2B</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x7E</span><span class=p>,</span> <span class=mh>0xBA</span><span class=p>,</span> <span class=mh>0x77</span><span class=p>,</span> <span class=mh>0xD6</span><span class=p>,</span> <span class=mh>0x26</span><span class=p>,</span> <span class=mh>0xE1</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x55</span><span class=p>,</span> <span class=mh>0x21</span><span class=p>,</span> <span class=mh>0x0C</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>expand_key</span><span class=p>(</span><span class=n>master_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Expands and returns a list of key matrices for the given master_key.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Round constants https://en.wikipedia.org/wiki/AES_key_schedule#Round_constants</span>
</span></span><span class=line><span class=cl>    <span class=n>r_con</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x1B</span><span class=p>,</span> <span class=mh>0x36</span><span class=p>,</span> <span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0xD8</span><span class=p>,</span> <span class=mh>0xAB</span><span class=p>,</span> <span class=mh>0x4D</span><span class=p>,</span> <span class=mh>0x9A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0x2F</span><span class=p>,</span> <span class=mh>0x5E</span><span class=p>,</span> <span class=mh>0xBC</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0xC6</span><span class=p>,</span> <span class=mh>0x97</span><span class=p>,</span> <span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x6A</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xD4</span><span class=p>,</span> <span class=mh>0xB3</span><span class=p>,</span> <span class=mh>0x7D</span><span class=p>,</span> <span class=mh>0xFA</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span> <span class=mh>0xC5</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Initialize round keys with raw key material.</span>
</span></span><span class=line><span class=cl>    <span class=n>key_columns</span> <span class=o>=</span> <span class=n>bytes2matrix</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iteration_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Each iteration has exactly as many columns as the key material.</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>N_ROUNDS</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Copy previous word.</span>
</span></span><span class=line><span class=cl>        <span class=n>word</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>key_columns</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Perform schedule_core once every &#34;row&#34;.</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>%</span> <span class=n>iteration_size</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Circular shift.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>word</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=c1># Map to S-BOX.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span> <span class=o>=</span> <span class=p>[</span><span class=n>s_box</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>word</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># XOR with first byte of R-CON, since the others bytes of R-CON are 0.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>r_con</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>master_key</span><span class=p>)</span> <span class=o>==</span> <span class=mi>32</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>%</span> <span class=n>iteration_size</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Run word through S-box in the fourth iteration when using a</span>
</span></span><span class=line><span class=cl>            <span class=c1># 256-bit key.</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span> <span class=o>=</span> <span class=p>[</span><span class=n>s_box</span><span class=p>[</span><span class=n>b</span><span class=p>]</span> <span class=k>for</span> <span class=n>b</span> <span class=ow>in</span> <span class=n>word</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># XOR with equivalent word from previous iteration.</span>
</span></span><span class=line><span class=cl>        <span class=n>word</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>i</span><span class=o>^</span><span class=n>j</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>word</span><span class=p>,</span> <span class=n>key_columns</span><span class=p>[</span><span class=o>-</span><span class=n>iteration_size</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>key_columns</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>word</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Group key words in 4x4 byte matrices.</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>key_columns</span><span class=p>[</span><span class=mi>4</span><span class=o>*</span><span class=n>i</span> <span class=p>:</span> <span class=mi>4</span><span class=o>*</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>key_columns</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>bytes2matrix</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Converts a 16-byte array into a 4x4 matrix.  &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=nb>list</span><span class=p>(</span><span class=n>text</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>4</span><span class=p>])</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>),</span> <span class=mi>4</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>matrix2bytes</span><span class=p>(</span><span class=n>matrix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_round_key</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[[</span><span class=n>s_val</span><span class=o>^</span><span class=n>k_val</span> <span class=k>for</span> <span class=n>s_val</span><span class=p>,</span> <span class=n>k_val</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>s_lst</span><span class=p>,</span><span class=n>k_lst</span><span class=p>)]</span> <span class=k>for</span> <span class=n>s_lst</span><span class=p>,</span> <span class=n>k_lst</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>k</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_shift_rows</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>1</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>2</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=mi>3</span><span class=p>],</span> <span class=n>s</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sub_bytes</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>sbox</span><span class=o>=</span><span class=n>s_box</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[[</span><span class=nb>int</span><span class=p>(</span><span class=n>sbox</span><span class=p>[</span><span class=n>a</span><span class=p>])</span> <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>row</span><span class=p>]</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>s</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># learned from http://cs.ucsb.edu/~koc/cs178/projects/JT/aes.c</span>
</span></span><span class=line><span class=cl><span class=n>xtime</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>a</span><span class=p>:</span> <span class=p>(((</span><span class=n>a</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=mh>0x1B</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xFF</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span> <span class=k>else</span> <span class=p>(</span><span class=n>a</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_single_column</span><span class=p>(</span><span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># see Sec 4.1.2 in The Design of Rijndael</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>u</span> <span class=o>=</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>^=</span> <span class=n>t</span> <span class=o>^</span> <span class=n>xtime</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>^</span> <span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>mix_single_column</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inv_mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># see Sec 4.1.3 in The Design of Rijndael</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>xtime</span><span class=p>(</span><span class=n>xtime</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>^</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span> <span class=o>=</span> <span class=n>xtime</span><span class=p>(</span><span class=n>xtime</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>^</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>3</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>^=</span> <span class=n>u</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span> <span class=o>^=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>2</span><span class=p>]</span> <span class=o>^=</span> <span class=n>u</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=mi>3</span><span class=p>]</span> <span class=o>^=</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mix_columns</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>round_keys</span> <span class=o>=</span> <span class=n>expand_key</span><span class=p>(</span><span class=n>key</span><span class=p>)</span> <span class=c1># Remember to start from the last round key and work backwards through them when decrypting</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert ciphertext to state matrix</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=n>bytes2matrix</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Initial add round key step</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N_ROUNDS</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>inv_shift_rows</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span> <span class=o>=</span> <span class=n>sub_bytes</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>inv_s_box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>inv_mix_columns</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Run final round (skips the InvMixColumns step)</span>
</span></span><span class=line><span class=cl>    <span class=n>inv_shift_rows</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=n>sub_bytes</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>inv_s_box</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=n>add_round_key</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>round_keys</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Convert state matrix to plaintext</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>=</span> <span class=n>matrix2bytes</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plaintext</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>decrypt</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>ciphertext</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=sa>b</span><span class=s1>&#39;crypto</span><span class=si>{MYAES128}</span><span class=s1>&#39;</span>
</span></span></code></pre></div><p><strong>flag:</strong> <code>crypto{MYAES128}</code></p><h2 id=modes-of-operation-starter>Modes of Operation Starter<a hidden class=anchor aria-hidden=true href=#modes-of-operation-starter>#</a></h2><blockquote><p>The previous set of challenges showed how AES performs a keyed permutation on a block of data. In practice, we need to encrypt messages much longer than a single block. A mode of operation describes how to use a cipher like AES on longer messages.</p><p>All modes have serious weaknesses when used incorrectly. The challenges in this category take you to a different section of the website where you can interact with APIs and exploit those weaknesses. Get yourself acquainted with the interface and use it to take your next flag!</p><p>Play at <a href=http://aes.cryptohack.org/block_cipher_starter title=http://aes.cryptohack.org/block_cipher_starter target=_blank rel="nofollow noopener">http://aes.cryptohack.org/block_cipher_starter</a></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/block_cipher_starter/decrypt/&lt;ciphertext&gt;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;plaintext&#34;</span><span class=p>:</span> <span class=n>decrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/block_cipher_starter/encrypt_flag/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_flag</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>FLAG</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-7>Solution<a hidden class=anchor aria-hidden=true href=#solution-7>#</a></h3><ol><li>Visit <a href=http://aes.cryptohack.org/block_cipher_starter title=http://aes.cryptohack.org/block_cipher_starter target=_blank rel="nofollow noopener">http://aes.cryptohack.org/block_cipher_starter</a></li><li>Visit <a href=https://aes.cryptohack.org//block_cipher_starter/encrypt_flag/ title=https://aes.cryptohack.org//block_cipher_starter/encrypt_flag/ target=_blank rel="nofollow noopener">https://aes.cryptohack.org//block_cipher_starter/encrypt_flag/</a></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>{&#34;ciphertext&#34;:&#34;1b36a55b687f21f73fe0bed721c1a5c305716a9a1c1745d50a39e0ae8f2fb9ba&#34;}
</span></span></code></pre></div><ol start=3><li>Decrypt ciphertext</li></ol><p><figure class=image-caption><img alt=decrypt srcset="/posts/cryptohack/symmetric_cryptography/images/decrypt_hu539554cee3909282d8d8bf9441c5216d_29740_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/decrypt_hu539554cee3909282d8d8bf9441c5216d_29740_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/decrypt_hu539554cee3909282d8d8bf9441c5216d_29740_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/decrypt.png width=768 height=391 loading=lazy><figcaption></figcaption></figure>4. Hex Decode</p><p><figure class=image-caption><img alt=decode srcset="/posts/cryptohack/symmetric_cryptography/images/decode_hud39c08c4d5ac24f7ddccb9fd52b05586_26235_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/decode_hud39c08c4d5ac24f7ddccb9fd52b05586_26235_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/decode_hud39c08c4d5ac24f7ddccb9fd52b05586_26235_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/decode.png width=768 height=233 loading=lazy><figcaption></figcaption></figure></p><p><strong>flag:</strong> <code>crypto{bl0ck_c1ph3r5_4r3_f457_!}</code></p><h2 id=passwords-as-keys>Passwords as Keys<a hidden class=anchor aria-hidden=true href=#passwords-as-keys>#</a></h2><blockquote><p>It is essential that keys in symmetric-key algorithms are random bytes, instead of passwords or other predictable data. The random bytes should be generated using a cryptographically-secure pseudorandom number generator (CSPRNG). If the keys are predictable in any way, then the security level of the cipher is reduced and it may be possible for an attacker who gets access to the ciphertext to decrypt it.</p><p>Just because a key looks like it is formed of random bytes, does not mean that it necessarily is. In this case the key has been derived from a simple password using a hashing function, which makes the ciphertext crackable.</p><p>For this challenge you may script your HTTP requests to the endpoints, or alternatively attack the ciphertext offline. Good luck!</p><p>Play at <a href=http://aes.cryptohack.org/passwords_as_keys title=http://aes.cryptohack.org/passwords_as_keys target=_blank rel="nofollow noopener">http://aes.cryptohack.org/passwords_as_keys</a></p></blockquote><h3 id=solution-8>Solution<a hidden class=anchor aria-hidden=true href=#solution-8>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>sleep</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Get Ciphertext</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s1>&#39;http://aes.cryptohack.org/passwords_as_keys&#39;</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/encrypt_flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Ciphertext: </span><span class=si>{</span><span class=n>ct</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Get word list</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://gist.githubusercontent.com/wchargin/8927565/raw/d9783627c731268fb2935a731a618aa8e95cf465/words&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>words</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Brute password</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>word</span> <span class=ow>in</span> <span class=n>words</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>word</span><span class=p>)</span><span class=o>.</span><span class=n>digest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>pt</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ct</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;crypto{&#34;</span> <span class=ow>in</span> <span class=n>pt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Plaintext: </span><span class=si>{</span><span class=n>pt</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>flag:</strong> <code>crypto{k3y5__r__n07__p455w0rdz?}</code></p><h2 id=ecb-oracle>ECB Oracle<a hidden class=anchor aria-hidden=true href=#ecb-oracle>#</a></h2><blockquote><p>ECB is the most simple mode, with each plaintext block encrypted entirely independently. In this case, your input is prepended to the secret flag and encrypted and that&rsquo;s it. We don&rsquo;t even provide a decrypt function. Perhaps you don&rsquo;t need a padding oracle when you have an &ldquo;ECB oracle&rdquo;?</p><p>Play at <a href=http://aes.cryptohack.org/ecb_oracle title=http://aes.cryptohack.org/ecb_oracle target=_blank rel="nofollow noopener">http://aes.cryptohack.org/ecb_oracle</a></p></blockquote><p><em>source code:</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span><span class=p>,</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/ecb_oracle/encrypt/&lt;plaintext&gt;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>padded</span> <span class=o>=</span> <span class=n>pad</span><span class=p>(</span><span class=n>plaintext</span> <span class=o>+</span> <span class=n>FLAG</span><span class=o>.</span><span class=n>encode</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>padded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-9>Solution<a hidden class=anchor aria-hidden=true href=#solution-9>#</a></h3><p>This problem was a bit difficult for me to solve. The first step in understanding it was looking more into how the <code>pad</code> function actually works in the backend of <code>pycryptodome</code>. This is more easily demonstrated through an example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=p>[</span><span class=n>pad</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;?&#39;</span><span class=o>*</span><span class=n>i</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>17</span><span class=p>)]</span> <span class=c1># We want to see 1-16, so we set the range to 17 since it doesn&#39;t include the last value.</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=sa>b</span><span class=s1>&#39;?</span><span class=se>\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;??</span><span class=se>\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;???</span><span class=se>\r\r\r\r\r\r\r\r\r\r\r\r\r</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;????</span><span class=se>\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;?????</span><span class=se>\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;??????</span><span class=se>\n\n\n\n\n\n\n\n\n\n</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;???????</span><span class=se>\t\t\t\t\t\t\t\t\t</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;????????</span><span class=se>\x08\x08\x08\x08\x08\x08\x08\x08</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;?????????</span><span class=se>\x07\x07\x07\x07\x07\x07\x07</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;??????????</span><span class=se>\x06\x06\x06\x06\x06\x06</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;???????????</span><span class=se>\x05\x05\x05\x05\x05</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;????????????</span><span class=se>\x04\x04\x04\x04</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;?????????????</span><span class=se>\x03\x03\x03</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;??????????????</span><span class=se>\x02\x02</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;???????????????</span><span class=se>\x01</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=sa>b</span><span class=s1>&#39;????????????????</span><span class=se>\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10</span><span class=s1>&#39;</span><span class=p>]</span>
</span></span></code></pre></div><p>When the amount of <code>?</code>&rsquo;s we provide is less than the <code>block_size</code> of 16, padding will be added. However, if 16 bytes (or <code>?</code>&rsquo;s) are provided, the <code>pad</code> function will create a new block (2 blocks of 16 bytes, totalling to 32 bytes in length). Therefore, if we give a bunch of garbage, we can leak the length of the flag.</p><p>TL;DR: we can measure the amount of bytes we send in alongside the amount of blocks that get generated to determine the flag length. So, if we send in <code>x-1</code> bytes and have 2 blocks (32 bytes total), then send in <code>x</code> bytes and have 3 blocks (48 bytes total), we know:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>flag_length = 2 blocks * 16 bytes/block - x bytes    -&gt;    32 bytes - x bytes
</span></span></code></pre></div><p>Time to script&mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plainhex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;https://aes.cryptohack.org/ecb_oracle/encrypt/</span><span class=si>{</span><span class=n>plainhex</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ciphers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>17</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>garbage</span> <span class=o>=</span> <span class=n>i</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;?&#39;</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ct</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Garbage (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span><span class=o>//</span><span class=mi>2</span><span class=si>}</span><span class=s2> bytes): </span><span class=si>{</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Ciphertext (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>//</span><span class=mi>2</span><span class=si>}</span><span class=s2> bytes): </span><span class=si>{</span><span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Garbage (1 bytes): ?
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): 341dd0bf293efbc386baa0450a9f7a121d91b08cbd0a3ff55d6225e7f2cb1fe1
</span></span><span class=line><span class=cl>Garbage (2 bytes): ??
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): c7404a9325a0b5bd6f663638f86f6d14133cfd98ad547f6a1dae2cdccac36bda
</span></span><span class=line><span class=cl>Garbage (3 bytes): ???
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): 1e46817be36af1d0d263fed68ab2b3b440b0f25961b3330f4880effcdd1d9372
</span></span><span class=line><span class=cl>Garbage (4 bytes): ????
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): 700b70280d82306f6b577da0e70914003775fe4513f275eeb4a20548db2b1372
</span></span><span class=line><span class=cl>Garbage (5 bytes): ?????
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): 043d72cd0c91d09ee654031196f6a203f0aaaa9734688f65f110768d242965f2
</span></span><span class=line><span class=cl>Garbage (6 bytes): ??????
</span></span><span class=line><span class=cl>Ciphertext (32 bytes): dd90d7562c5d17c5ff323f1a024483749f1d9ea23fc3f0857e80d9254d053b99
</span></span><span class=line><span class=cl>Garbage (7 bytes): ???????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): d32166eeaa47575cf04ae32526b6006c1f227170511203bbb211a703905f9e5128ae38bc1312435b814108836328262a
</span></span><span class=line><span class=cl>Garbage (8 bytes): ????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 9eaa653b150e6218b56d887fb99d00f21206ed1975a928fe0813952f43171080b6800d8b95758d3bf16d0f75ca9f38e8
</span></span><span class=line><span class=cl>Garbage (9 bytes): ?????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 7a987178f47d51a9d650fdd312580bf50e5eaa21119c631ae8304d9d2c1ef310593c7d830f153c8a4b7f41c116065d73
</span></span><span class=line><span class=cl>Garbage (10 bytes): ??????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 66a3abc4b4b82020586064a647d7fa75e1434b90c1f8633f9818265dfff40e08c9dd5d6a2703d3beb1def6e688083f3a
</span></span><span class=line><span class=cl>Garbage (11 bytes): ???????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 0fd571c8e551af19d186a30c9b3c02034cc4a08218ed3d4aead3c49d2c49e5b5ed8db991b61458ce267a94b891a472fb
</span></span><span class=line><span class=cl>Garbage (12 bytes): ????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 12d380f787bdbc1bc7a4b8619f45609af2f1b66e09e912eff09384648f453f3db11abf8572ab7a34347ada3026bf0911
</span></span><span class=line><span class=cl>Garbage (13 bytes): ?????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): ae7db02691622c4562866713fa013c5cee268318401e6c194260a8ffa3d2df71190f2b09607b5764d577d4d5569b9059
</span></span><span class=line><span class=cl>Garbage (14 bytes): ??????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc7bd036db83a337f9f4f867dd5691e1f7fd105ad78e0e6fa84f694743dd59cc94
</span></span><span class=line><span class=cl>Garbage (15 bytes): ???????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): eed4350b17297b157330c401581ac453a6734bcc83eace3a107321af7775026b7d715d5c670622e24c462ae108288f25
</span></span><span class=line><span class=cl>Garbage (16 bytes): ????????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): da572df43b1a6bd8ad66da297d64c445bea177bc81b326eef475195dee42ba6c2eb3958aa4a3fa0d49789f5152a4eed2
</span></span></code></pre></div><p>As shown above, we can see that when 7 bytes of garbage are sent in, a new block is made. This meas our flag must be <code>32-7 = 25 bytes</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=n>flag_len</span> <span class=o>=</span> <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>//</span><span class=mi>2</span> <span class=o>-</span> <span class=n>x</span> <span class=o>-</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>ciphers</span><span class=p>,</span><span class=n>ciphers</span><span class=p>[</span><span class=mi>1</span><span class=p>:]))</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>j</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>&gt;</span><span class=nb>len</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>hex</span><span class=p>())][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=mi>25</span>
</span></span></code></pre></div><p>From here, we know that the flag will need be held within 2 blocks. If we want to leak the flag, we will need 4 blocks total (2 for garbage and leaking + 2 for holding the flag and padding) totalling to 64 bytes. To make more sense of how this works, let&rsquo;s start with leaking a few bytes manually.</p><p>From previous challenges, let&rsquo;s assume the flag does adhere to the format <code>crypto{...}</code>. When scripting, its easy to check all possible bytes, but since this is an example and its manual, let&rsquo;s be smart and guess the first byte is <code>c</code>. From above, we can see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Garbage (15 bytes): ???????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): eed4350b17297b157330c401581ac453a6734bcc83eace3a107321af7775026b7d715d5c670622e24c462ae108288f25
</span></span></code></pre></div><p>As we remember, each block is 16 bytes. Since we only sent in 15 bytes and this plaintext is prepended to the flag, we <em>know</em> that the next byte (16th byte) has to be the first byte of the flag. We also know that each block is independent and will have its own ciphertext. This means that if the 16th byte is the same as the first byte of the flag, we will get the <em>same</em> ciphertext for block 1. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Garbage (15 bytes): ???????????????
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): eed4350b17297b157330c401581ac453  a6734bcc83eace3a107321af7775026b  7d715d5c670622e24c462ae108288f25
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Garbage (15 bytes) + &#39;c&#39; (1 byte): ???????????????c
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): eed4350b17297b157330c401581ac453  bea177bc81b326eef475195dee42ba6c  2eb3958aa4a3fa0d49789f5152a4eed2
</span></span></code></pre></div><p>As we can see, the first block of ciphertext for each payload is the same. <code>eed4350b17297b157330c401581ac453 == eed4350b17297b157330c401581ac453</code></p><p>Let&rsquo;s try it again for the sake of clarity. Now that we know the first letter of the flag is <code>c</code>, we need to reduce the amount of garbage we send in to 14 bytes (<code>14 + len('c') = 15</code>) so there is only byte we need to guess. We can try <code>r</code> due to the flag format.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Garbage (14 bytes) + &#39;c&#39; (1 byte): ??????????????c
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc  7bd036db83a337f9f4f867dd5691e1f7  fd105ad78e0e6fa84f694743dd59cc94
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Garbage (14 bytes) + &#39;c&#39; (1 byte) + &#39;r&#39; (1 byte): ??????????????cr
</span></span><span class=line><span class=cl>Ciphertext (48 bytes): 5f26e6ffabb6962705a174ac4b463bcc  bea177bc81b326eef475195dee42ba6c  2eb3958aa4a3fa0d49789f5152a4eed2
</span></span></code></pre></div><p>That&rsquo;s it basically. Just script this process!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plainhex</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;https://aes.cryptohack.org/ecb_oracle/encrypt/</span><span class=si>{</span><span class=n>plainhex</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ciphers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>17</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>garbage</span> <span class=o>=</span> <span class=n>i</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;?&#39;</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ct</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Garbage (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span><span class=o>//</span><span class=mi>2</span><span class=si>}</span><span class=s2> bytes): </span><span class=si>{</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>garbage</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Ciphertext (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>//</span><span class=mi>2</span><span class=si>}</span><span class=s2> bytes): </span><span class=si>{</span><span class=n>ct</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Calculate flag length (easier visually)</span>
</span></span><span class=line><span class=cl><span class=n>flag_len</span> <span class=o>=</span> <span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>//</span><span class=mi>2</span> <span class=o>-</span> <span class=n>x</span> <span class=o>-</span> <span class=mi>2</span> <span class=k>for</span> <span class=n>x</span><span class=p>,</span> <span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>ciphers</span><span class=p>,</span><span class=n>ciphers</span><span class=p>[</span><span class=mi>1</span><span class=p>:]))</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>j</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span><span class=o>&gt;</span><span class=nb>len</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>hex</span><span class=p>())][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Put likely strings and letters at the beginning - remove duplicates</span>
</span></span><span class=line><span class=cl><span class=n>alpha</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>dict</span><span class=o>.</span><span class=n>fromkeys</span><span class=p>(</span><span class=s2>&#34;crypto</span><span class=si>{eainshr_}</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>digits</span> <span class=o>+</span> <span class=n>string</span><span class=o>.</span><span class=n>ascii_uppercase</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Brute forcing flag...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>31</span><span class=p>,</span> <span class=mi>31</span><span class=o>-</span><span class=n>flag_len</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>alpha</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>char</span> <span class=o>=</span> <span class=n>char</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>ct</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>((</span><span class=n>i</span><span class=o>*</span><span class=sa>b</span><span class=s2>&#34;?&#34;</span><span class=o>+</span><span class=n>flag</span><span class=o>+</span><span class=n>char</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>())[:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>exp</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>((</span><span class=n>i</span><span class=o>*</span><span class=sa>b</span><span class=s2>&#34;?&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>())[:</span><span class=mi>32</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ct</span> <span class=o>==</span> <span class=n>exp</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>+=</span> <span class=n>char</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>char</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>flag:</strong> <code>crypto{p3n6u1n5_h473_3cb}</code></p><h2 id=ecb-cbc-wtf>ECB CBC WTF<a hidden class=anchor aria-hidden=true href=#ecb-cbc-wtf>#</a></h2><blockquote><p>Here you can encrypt in CBC but only decrypt in ECB. That shouldn&rsquo;t be a weakness because they&rsquo;re different modes&mldr; right?</p><p>Play at <a href=http://aes.cryptohack.org/ecbcbcwtf title=http://aes.cryptohack.org/ecbcbcwtf target=_blank rel="nofollow noopener">http://aes.cryptohack.org/ecbcbcwtf</a></p></blockquote><p><em>source code:</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/ecbcbcwtf/decrypt/&lt;ciphertext&gt;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;plaintext&#34;</span><span class=p>:</span> <span class=n>decrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/ecbcbcwtf/encrypt_flag/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_flag</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>FLAG</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span> <span class=o>+</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=n>ciphertext</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-10>Solution<a hidden class=anchor aria-hidden=true href=#solution-10>#</a></h3><p>To solve this challenge, we first need to look at the differences between CBC and ECB.</p><p><figure class=image-caption><img alt=ecb srcset="/posts/cryptohack/symmetric_cryptography/images/ecb.i_hu3fb3f45091354f9ad40bf0a4479140ab_69461_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/ecb.i_hu3fb3f45091354f9ad40bf0a4479140ab_69461_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/ecb.i_hu3fb3f45091354f9ad40bf0a4479140ab_69461_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/ecb.i.png width=768 height=624 loading=lazy style=filter:var(--invert-img)><figcaption></figcaption></figure><figure class=image-caption><img alt=cbc srcset="/posts/cryptohack/symmetric_cryptography/images/cbc.i_hu8735f73f31d80fa0f19aaf2946768cd0_117576_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/cbc.i_hu8735f73f31d80fa0f19aaf2946768cd0_117576_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/cbc.i_hu8735f73f31d80fa0f19aaf2946768cd0_117576_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/cbc.i.png width=768 height=608 loading=lazy style=filter:var(--invert-img)><figcaption></figcaption></figure></p><p>This boils down to the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ECB
</span></span><span class=line><span class=cl> Encryption: c1=p1^key      c2=p2^key
</span></span><span class=line><span class=cl> Decryption: p1=c1^key      p2=c2^key
</span></span><span class=line><span class=cl>CBC
</span></span><span class=line><span class=cl> Encryption: c1=p1^key^iv   c2=c1^p2
</span></span><span class=line><span class=cl> Decryption: p1=c1^key^iv   p2=c1^c2
</span></span></code></pre></div><p>Since <code>iv</code> in this case is random, we will not be able to decrypt <code>p1</code>. However, we can decrypt <code>p2</code> and <code>p3</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_ct</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; gets ciphertext of flag &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://aes.cryptohack.org/ecbcbcwtf/encrypt_flag/&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_pt</span><span class=p>(</span><span class=n>ct</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; gets plaintext of given ciphertext &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://aes.cryptohack.org/ecbcbcwtf/decrypt/&#34;</span><span class=o>+</span><span class=n>ct</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;plaintext&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>blockify</span><span class=p>(</span><span class=n>txt</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; turns text into list of blocks &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>txt</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>size</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>txt</span><span class=p>),</span> <span class=n>size</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=n>request_ct</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>pt</span> <span class=o>=</span> <span class=n>request_pt</span><span class=p>(</span><span class=n>ct</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ct_blocks</span> <span class=o>=</span> <span class=n>blockify</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span> <span class=c1># 16 bytes * 2 since hex!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>flag</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>c</span><span class=p>,</span><span class=n>p</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ct_blocks</span><span class=p>,</span> <span class=n>ct_blocks</span><span class=p>[</span><span class=mi>1</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>    <span class=n>current_block_ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>next_block_pt</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>request_pt</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>flag</span> <span class=o>+=</span> <span class=n>xor</span><span class=p>(</span><span class=n>current_block_ct</span><span class=p>,</span> <span class=n>next_block_pt</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=n>flag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>crypto</span><span class=p>{</span><span class=mi>3</span><span class=n>cb_5uck5_4v01d_17_</span><span class=err>!!!!!</span><span class=p>}</span>
</span></span></code></pre></div><p>Alternate solution(s):<figure class=image-caption><img alt=sol srcset="/posts/cryptohack/symmetric_cryptography/images/sol_hu449fa261f705a6c8fb3afa5554b0e107_187415_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/sol_hu449fa261f705a6c8fb3afa5554b0e107_187415_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/sol_hu449fa261f705a6c8fb3afa5554b0e107_187415_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/sol.png width=768 height=424 loading=lazy><figcaption></figcaption></figure></p><p><strong>flag:</strong> <code>crypto{3cb_5uck5_4v01d_17_!!!!!}</code></p><h2 id=flipping-cookie>Flipping Cookie<a hidden class=anchor aria-hidden=true href=#flipping-cookie>#</a></h2><blockquote><p>You can get a cookie for my website, but it won&rsquo;t help you read the flag&mldr; I think.</p><p>Play at <a href=http://aes.cryptohack.org/flipping_cookie title=http://aes.cryptohack.org/flipping_cookie target=_blank rel="nofollow noopener">http://aes.cryptohack.org/flipping_cookie</a></p></blockquote><p><em>source code:</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Util.Padding</span> <span class=kn>import</span> <span class=n>pad</span><span class=p>,</span> <span class=n>unpad</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/flipping_cookie/check_admin/&lt;cookie&gt;/&lt;iv&gt;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_admin</span><span class=p>(</span><span class=n>cookie</span><span class=p>,</span> <span class=n>iv</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>unpadded</span> <span class=o>=</span> <span class=n>unpad</span><span class=p>(</span><span class=n>decrypted</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s2>&#34;admin=True&#34;</span> <span class=ow>in</span> <span class=n>unpadded</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;;&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;flag&#34;</span><span class=p>:</span> <span class=n>FLAG</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Only admin can read the flag&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/flipping_cookie/get_cookie/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_cookie</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>expires_at</span> <span class=o>=</span> <span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>today</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;admin=False;expiry=</span><span class=si>{</span><span class=n>expires_at</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>padded</span> <span class=o>=</span> <span class=n>pad</span><span class=p>(</span><span class=n>cookie</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_CBC</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>padded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span> <span class=o>+</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;cookie&#34;</span><span class=p>:</span> <span class=n>ciphertext</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-11>Solution<a hidden class=anchor aria-hidden=true href=#solution-11>#</a></h3><p>To solve this problem, turning CBC decryption into a system of equations makes the rest trivial. As we previously covered (see the images above), CBC decryption can be broken down like so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Encryption:
</span></span><span class=line><span class=cl>    p1 ^ iv ^ key = c1
</span></span><span class=line><span class=cl>    p2 ^ c1 ^ key = c2
</span></span><span class=line><span class=cl>    p3 ^ c2 ^ key = c3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Decryption:
</span></span><span class=line><span class=cl>    c1 ^ key ^ iv = p1
</span></span><span class=line><span class=cl>    c1 ^ d(c2) = p2
</span></span><span class=line><span class=cl>    c2 ^ d(c3) = p3
</span></span></code></pre></div><p>From the source code, we are given <code>iv</code>, the <code>ciphertext</code>, and the <code>plaintext</code>. However, it turns out we only really need <code>iv</code> and <code>p1</code> to solve. This is because our goal is only to change <code>admin=False</code> to <code>admin=True</code> through our own malicious <code>iv</code> payload. Let&rsquo;s change these terms to something more readily understandable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>1.
</span></span><span class=line><span class=cl>p1 ^ iv ^ key = c1    -&gt;    given_pt ^ given_iv ^ tmp_key = tmp_ct
</span></span><span class=line><span class=cl>c1 ^ key ^ iv = p1    -&gt;    tmp_ct ^ tmp_key ^ iv_payload = pt_payload
</span></span><span class=line><span class=cl>________________________________________________________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2. (given_pt ^ given_iv ^ tmp_key) ^ tmp_key ^ iv_payload = pt_payload
</span></span><span class=line><span class=cl>________________________________________________________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3. given_pt ^ given_iv ^ iv_payload = pt_payload
</span></span><span class=line><span class=cl>________________________________________________________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>4. iv_payload = pt_payload ^ given_iv ^ given_pt
</span></span></code></pre></div><p>So all we have to do is XOR our desired plaintext <code>admin=True...</code> with the given <code>iv</code> and the given plaintext <code>admin=False...</code> to get our <code>iv_payload</code>. Then, we can just send this payload to the server and get the flag!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ciphertext</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;http://aes.cryptohack.org/flipping_cookie/get_cookie&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;cookie&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_admin</span><span class=p>(</span><span class=n>cookie</span><span class=p>,</span><span class=n>iv</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;http://aes.cryptohack.org/flipping_cookie/check_admin/</span><span class=si>{</span><span class=n>cookie</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>iv</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>get_ciphertext</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>ct</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=n>ct</span><span class=p>[</span><span class=mi>16</span><span class=p>:]</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pt</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;admin=False;expiry=&#39;</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>pt_payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;admin=True;expiry=&#39;</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>iv_payload</span> <span class=o>=</span> <span class=n>xor</span><span class=p>(</span><span class=n>pt_payload</span><span class=p>,</span> <span class=n>pt</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>check_admin</span><span class=p>(</span><span class=n>cookie</span><span class=p>,</span> <span class=n>iv_payload</span><span class=p>)[</span><span class=s1>&#39;flag&#39;</span><span class=p>])</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>flag:</strong> <code>crypto{4u7h3n71c4710n_15_3553n714l}</code></p><h2 id=symmetry>Symmetry<a hidden class=anchor aria-hidden=true href=#symmetry>#</a></h2><blockquote><p>Some block cipher modes, such as OFB, CTR, or CFB, turn a block cipher into a stream cipher. The idea behind stream ciphers is to produce a pseudorandom keystream which is then XORed with the plaintext. One advantage of stream ciphers is that they can work of plaintext of arbitrary length, with no padding required.</p><p>OFB is an obscure cipher mode, with no real benefits these days over using CTR. This challenge introduces an unusual property of OFB.</p><p>Play at <a href=http://aes.cryptohack.org/symmetry title=http://aes.cryptohack.org/symmetry target=_blank rel="nofollow noopener">http://aes.cryptohack.org/symmetry</a></p></blockquote><p><em>source code:</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl><span class=n>FLAG</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/symmetry/encrypt/&lt;plaintext&gt;/&lt;iv&gt;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>,</span> <span class=n>iv</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>plaintext</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>iv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>16</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;IV length must be 16&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_OFB</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=n>ciphertext</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/symmetry/encrypt_flag/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_flag</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>iv</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_OFB</span><span class=p>,</span> <span class=n>iv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>encrypted</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>FLAG</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphertext</span> <span class=o>=</span> <span class=n>iv</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span> <span class=o>+</span> <span class=n>encrypted</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;ciphertext&#34;</span><span class=p>:</span> <span class=n>ciphertext</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-12>Solution<a hidden class=anchor aria-hidden=true href=#solution-12>#</a></h3><p>After checking <a href=https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Output_feedback_%28OFB%29 title=Wikipedia target=_blank rel="nofollow noopener">Wikipedia</a>, I realized the encryption and decryption methods are the same for <code>OFB</code>! We&rsquo;ve got all we need.<figure class=image-caption><img alt=ofb srcset="/posts/cryptohack/symmetric_cryptography/images/ofb.i_hua5870ed67db65e47216040d890cbd1ca_220689_480x0_resize_q75_h2_box_3.webp 480w,
/posts/cryptohack/symmetric_cryptography/images/ofb.i_hua5870ed67db65e47216040d890cbd1ca_220689_768x0_resize_q75_h2_box_3.webp 768w,
/posts/cryptohack/symmetric_cryptography/images/ofb.i_hua5870ed67db65e47216040d890cbd1ca_220689_1024x0_resize_q75_h2_box_3.webp 1024w" sizes=100vw src=images/ofb.i.png width=768 height=607 loading=lazy style=filter:var(--invert-img)><figcaption></figcaption></figure></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ciphertext</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://aes.cryptohack.org/symmetry/encrypt_flag/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_flag</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>iv</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;https://aes.cryptohack.org/symmetry/encrypt/</span><span class=si>{</span><span class=n>ct</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>iv</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;ciphertext&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>get_ciphertext</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>iv</span> <span class=o>=</span> <span class=n>ct</span><span class=p>[:</span><span class=mi>16</span><span class=p>]</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=n>ct</span><span class=p>[</span><span class=mi>16</span><span class=p>:]</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>get_flag</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>iv</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>flag:</strong> <code>crypto{0fb_15_5ymm37r1c4l_!!!11!}</code></p><h2 id=bean-counter>Bean Counter<a hidden class=anchor aria-hidden=true href=#bean-counter>#</a></h2><blockquote><p>I&rsquo;ve struggled to get PyCrypto&rsquo;s counter mode doing what I want, so I&rsquo;ve turned ECB mode into CTR myself. My counter can go both upwards and downwards to throw off cryptanalysts! There&rsquo;s no chance they&rsquo;ll be able to read my picture.</p><p>Play at <a href=http://aes.cryptohack.org/bean_counter title=http://aes.cryptohack.org/bean_counter target=_blank rel="nofollow noopener">http://aes.cryptohack.org/bean_counter</a></p></blockquote><p><em>source code:</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>Crypto.Cipher</span> <span class=kn>import</span> <span class=n>AES</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KEY</span> <span class=o>=</span> <span class=err>?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StepUpCounter</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>16</span><span class=p>),</span> <span class=n>step_up</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>step</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>stup</span> <span class=o>=</span> <span class=n>step_up</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>increment</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>stup</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>newIV</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>value</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>step</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>newIV</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>value</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>stup</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>newIV</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>newIV</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>32</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>increment</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@chal</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/bean_counter/encrypt/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>cipher</span> <span class=o>=</span> <span class=n>AES</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>KEY</span><span class=p>,</span> <span class=n>AES</span><span class=o>.</span><span class=n>MODE_ECB</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ctr</span> <span class=o>=</span> <span class=n>StepUpCounter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;challenge_files/bean_flag.png&#34;</span><span class=p>,</span> <span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>block</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>block</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>keystream</span> <span class=o>=</span> <span class=n>cipher</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>ctr</span><span class=o>.</span><span class=n>increment</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>xored</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span><span class=o>^</span><span class=n>b</span> <span class=k>for</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>block</span><span class=p>,</span> <span class=n>keystream</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>            <span class=n>out</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>bytes</span><span class=p>(</span><span class=n>xored</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>block</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;encrypted&#34;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>out</span><span class=p>)}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=solution-13>Solution<a hidden class=anchor aria-hidden=true href=#solution-13>#</a></h3><p>The trick to this solution is realizing that we know <code>plaintext</code> (png header) and <code>ciphertext</code> (given) of the first block. We can use this to calculate the key and then ultimately decrypt the rest of the ciphertext.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>png_header</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=s1>&#39;89504e470d0a1a0a0000000d49484452&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ciphertext</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://aes.cryptohack.org/bean_counter/encrypt/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s1>&#39;encrypted&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ct</span> <span class=o>=</span> <span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>get_ciphertext</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>key</span> <span class=o>=</span> <span class=n>xor</span><span class=p>(</span><span class=n>png_header</span><span class=p>,</span> <span class=n>ct</span><span class=p>[:</span><span class=mi>16</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>pt</span> <span class=o>=</span> <span class=n>xor</span><span class=p>(</span><span class=n>ct</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;bean.png&#39;</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><figure class=image-caption><img src=images/bean.i.png#center alt=bean style=filter:var(--invert-img) loading=lazy><figcaption>[ <em>bean.png</em> ]</figcaption></figure></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://woadey.lol/tags/crypto/>crypto</a></li><li><a href=https://woadey.lol/tags/aes/>aes</a></li></ul><nav class=paginav><a class=next href=https://woadey.lol/posts/htb/startingpoint-tier2/><span class=title>Next »</span><br><span>HTB: Learn the basics of Penetration Testing - Tier 2</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://woadey.lol/>woadey</a></span>
<span>· Theme: tweaked
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>